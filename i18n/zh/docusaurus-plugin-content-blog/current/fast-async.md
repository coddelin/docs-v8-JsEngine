---
title: 'æ›´å¿«çš„å¼‚æ­¥å‡½æ•°å’ŒPromise'
author: 'Maya Armyanovaï¼ˆ[@Zmayski](https://twitter.com/Zmayski)ï¼‰ï¼Œæ°¸è¿œç­‰å¾…çš„é¢„æµ‹è€…ï¼Œä»¥åŠBenedikt Meurerï¼ˆ[@bmeurer](https://twitter.com/bmeurer)ï¼‰ï¼Œä¸“ä¸šæ€§èƒ½æ‰¿è¯ºè€…'
avatars:
  - 'maya-armyanova'
  - 'benedikt-meurer'
date: 2018-11-12 16:45:07
tags:
  - ECMAScript
  - åŸºå‡†æµ‹è¯•
  - æ¼”è®²
description: 'æ›´å¿«ä¸”æ›´æ˜“äºè°ƒè¯•çš„å¼‚æ­¥å‡½æ•°å’ŒPromiseå³å°†ç™»é™†V8 v7.2 / Chrome 72ã€‚'
tweet: '1062000102909169670'
---
JavaScriptä¸­çš„å¼‚æ­¥å¤„ç†ä¼ ç»Ÿä¸Šè¢«è®¤ä¸ºé€Ÿåº¦ä¸æ˜¯ç‰¹åˆ«å¿«ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè°ƒè¯•å®æ—¶JavaScriptåº”ç”¨ç¨‹åºâ€”â€”ç‰¹åˆ«æ˜¯Node.jsæœåŠ¡å™¨â€”â€”å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ï¼Œå°¤å…¶æ˜¯å¼‚æ­¥ç¼–ç¨‹ã€‚å¹¸è¿çš„æ˜¯ï¼Œæ—¶ä»£æ­£åœ¨æ”¹å˜ã€‚è¿™ç¯‡æ–‡ç« æ¢è®¨äº†æˆ‘ä»¬å¦‚ä½•ä¼˜åŒ–V8ä¸­çš„å¼‚æ­¥å‡½æ•°å’ŒPromiseï¼ˆä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šä¼˜åŒ–äº†å…¶ä»–JavaScriptå¼•æ“ï¼‰ï¼Œå¹¶æè¿°äº†æˆ‘ä»¬å¦‚ä½•æ”¹è¿›å¼‚æ­¥ä»£ç çš„è°ƒè¯•ä½“éªŒã€‚

<!--truncate-->
:::note
**æ³¨æ„:** å¦‚æœæ‚¨æ›´å–œæ¬¢çœ‹æ¼”è®²è€Œä¸æ˜¯é˜…è¯»æ–‡ç« ï¼Œé‚£ä¹ˆå¯ä»¥æ¬£èµä¸‹é¢çš„è§†é¢‘ï¼å¦‚æœä¸å–œæ¬¢ï¼Œè¯·è·³è¿‡è§†é¢‘å¹¶ç»§ç»­é˜…è¯»ã€‚
:::

<figure>
  <div class="è§†é¢‘ è§†é¢‘-16:9">
    <iframe src="https://www.youtube.com/embed/DFP5DKDQfOc" width="640" height="360" loading="lazy"></iframe>
  </div>
</figure>

## ä¸€ç§æ–°çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ³•

### ä»å›è°ƒåˆ°Promiseå†åˆ°å¼‚æ­¥å‡½æ•°

åœ¨Promiseæˆä¸ºJavaScriptè¯­è¨€çš„ä¸€éƒ¨åˆ†ä¹‹å‰ï¼ŒåŸºäºå›è°ƒçš„APIé€šå¸¸ç”¨äºå¼‚æ­¥ä»£ç ï¼Œç‰¹åˆ«æ˜¯åœ¨Node.jsä¸­ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```js
function handler(done) {
  validateParams((error) => {
    if (error) return done(error);
    dbQuery((error, dbResults) => {
      if (error) return done(error);
      serviceCall(dbResults, (error, serviceResults) => {
        console.log(result);
        done(error, serviceResults);
      });
    });
  });
}
```

è¿™ç§æ·±åº¦åµŒå¥—å›è°ƒçš„ä½¿ç”¨æ¨¡å¼é€šå¸¸è¢«ç§°ä¸ºâ€œå›è°ƒåœ°ç‹±â€ï¼Œå› ä¸ºå®ƒä½¿ä»£ç éš¾ä»¥é˜…è¯»ä¸”éš¾ä»¥ç»´æŠ¤ã€‚

å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨æœ‰äº†Promiseæˆä¸ºJavaScriptè¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼ŒåŒæ ·çš„ä»£ç å¯ä»¥ä»¥æ›´ä¼˜é›…å’Œä¾¿äºç»´æŠ¤çš„æ–¹å¼ç¼–å†™ï¼š

```js
function handler() {
  return validateParams()
    .then(dbQuery)
    .then(serviceCall)
    .then(result => {
      console.log(result);
      return result;
    });
}
```

æœ€è¿‘ï¼ŒJavaScriptè¿˜æ”¯æŒäº†[å¼‚æ­¥å‡½æ•°](https://web.dev/articles/async-functions)ã€‚ä¸Šè¿°å¼‚æ­¥ä»£ç ç°åœ¨å¯ä»¥ç”¨çœ‹èµ·æ¥éå¸¸ç±»ä¼¼åŒæ­¥ä»£ç çš„æ–¹å¼ç¼–å†™ï¼š

```js
async function handler() {
  await validateParams();
  const dbResults = await dbQuery();
  const results = await serviceCall(dbResults);
  console.log(results);
  return results;
}
```

ä½¿ç”¨å¼‚æ­¥å‡½æ•°ä»£ç å˜å¾—æ›´åŠ ç®€æ´ï¼Œå¹¶ä¸”æ§åˆ¶å’Œæ•°æ®æµæ›´å®¹æ˜“è·Ÿè¸ªï¼Œå°½ç®¡æ‰§è¡Œä»ç„¶æ˜¯å¼‚æ­¥çš„ã€‚ï¼ˆæ³¨æ„ï¼ŒJavaScriptçš„æ‰§è¡Œä»ç„¶å‘ç”Ÿåœ¨å•çº¿ç¨‹ä¸­ï¼Œè¿™æ„å‘³ç€å¼‚æ­¥å‡½æ•°æœ¬èº«ä¸ä¼šåˆ›å»ºç‰©ç†çº¿ç¨‹ã€‚ï¼‰

### ä»äº‹ä»¶ç›‘å¬å™¨å›è°ƒåˆ°å¼‚æ­¥è¿­ä»£

å¦ä¸€ç§å¼‚æ­¥èŒƒå¼ï¼Œå°¤å…¶æ˜¯åœ¨Node.jsä¸­å¾ˆå¸¸è§ï¼Œæ˜¯[`ReadableStream`](https://nodejs.org/api/stream.html#stream_readable_streams)ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```js
const http = require('http');

http.createServer((req, res) => {
  let body = '';
  req.setEncoding('utf8');
  req.on('data', (chunk) => {
    body += chunk;
  });
  req.on('end', () => {
    res.write(body);
    res.end();
  });
}).listen(1337);
```

è¿™æ®µä»£ç å¯èƒ½æœ‰ç‚¹éš¾ä»¥è·Ÿéšï¼šæ¥æ”¶çš„æ•°æ®æŒ‰å—å¤„ç†ï¼Œè¿™äº›å—åªèƒ½åœ¨å›è°ƒä¸­è®¿é—®ï¼Œè€Œæµç»“æŸä¿¡å·ä¹Ÿå‘ç”Ÿåœ¨å›è°ƒä¸­ã€‚å½“ä½ æ²¡æœ‰æ„è¯†åˆ°å‡½æ•°ä¼šç«‹å³ç»ˆæ­¢ï¼Œå®é™…å¤„ç†å¿…é¡»å‘ç”Ÿåœ¨å›è°ƒä¸­æ—¶ï¼Œå®¹æ˜“å¼•å…¥é”™è¯¯ã€‚

å¹¸è¿çš„æ˜¯ï¼Œä¸€ä¸ªåä¸º[å¼‚æ­¥è¿­ä»£](http://2ality.com/2016/10/asynchronous-iteration.html)çš„ES2018æ–°ç‰¹æ€§å¯ä»¥ç®€åŒ–è¿™æ®µä»£ç ï¼š

```js
const http = require('http');

http.createServer(async (req, res) => {
  try {
    let body = '';
    req.setEncoding('utf8');
    for await (const chunk of req) {
      body += chunk;
    }
    res.write(body);
    res.end();
  } catch {
    res.statusCode = 500;
    res.end();
  }
}).listen(1337);
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®é™…å¤„ç†è¯·æ±‚çš„é€»è¾‘æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„å¼‚æ­¥å‡½æ•°ä¸­ï¼Œè€Œä¸æ˜¯ä¸¤ä¸ªä¸åŒçš„å›è°ƒâ€”â€”`'data'`å’Œ`'end'`å›è°ƒï¼Œå¹¶ä½¿ç”¨æ–°çš„`for awaitâ€¦of`å¾ªç¯å¼‚æ­¥è¿­ä»£å—ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº†ä¸€ä¸ª`try-catch`å—æ¥é¿å…`unhandledRejection`é—®é¢˜[^1]ã€‚

[^1]: æ„Ÿè°¢ [Matteo Collina](https://twitter.com/matteocollina) æŒ‡å‡º [è¿™ä¸ªé—®é¢˜](https://github.com/mcollina/make-promises-safe/blob/master/README.md#the-unhandledrejection-problem)ã€‚

ä½ ä»Šå¤©å°±å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨è¿™äº›æ–°åŠŸèƒ½äº†ï¼å¼‚æ­¥å‡½æ•°ä» **Node.js 8 (V8 v6.2 / Chrome 62)** å¼€å§‹å®Œå…¨æ”¯æŒï¼Œå¼‚æ­¥è¿­ä»£å™¨å’Œç”Ÿæˆå™¨ä» **Node.js 10 (V8 v6.8 / Chrome 68)** å¼€å§‹å®Œå…¨æ”¯æŒï¼

## å¼‚æ­¥æ€§èƒ½æ”¹è¿›

æˆ‘ä»¬å·²ç»æˆåŠŸåœ°åœ¨ V8 v5.5 (Chrome 55 & Node.js 7) å’Œ V8 v6.8 (Chrome 68 & Node.js 10) ä¹‹é—´æ˜¾è‘—æé«˜äº†å¼‚æ­¥ä»£ç çš„æ€§èƒ½ã€‚æˆ‘ä»¬è¾¾åˆ°äº†ä¸€ä¸ªå¼€å‘è€…å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨è¿™äº›æ–°çš„ç¼–ç¨‹èŒƒå¼è€Œä¸å¿…æ‹…å¿ƒé€Ÿåº¦çš„æ€§èƒ½æ°´å¹³ã€‚

![](/_img/fast-async/doxbee-benchmark.svg)

ä¸Šå›¾æ˜¾ç¤ºäº† [doxbee åŸºå‡†æµ‹è¯•](https://github.com/v8/promise-performance-tests/blob/master/lib/doxbee-async.js)ï¼Œè¯¥æµ‹è¯•æµ‹é‡äº†å¤§é‡ä½¿ç”¨ Promise çš„ä»£ç çš„æ€§èƒ½ã€‚è¯·æ³¨æ„ï¼Œå›¾è¡¨è¡¨ç¤ºæ‰§è¡Œæ—¶é—´ï¼Œå› æ­¤è¶Šä½è¶Šå¥½ã€‚

åœ¨ [parallel åŸºå‡†æµ‹è¯•](https://github.com/v8/promise-performance-tests/blob/master/lib/parallel-async.js) ä¸­ï¼Œä¸“é—¨æµ‹è¯•äº† [`Promise.all()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all) çš„æ€§èƒ½ï¼Œç»“æœæ›´ä»¤äººæŒ¯å¥‹ï¼š

![](/_img/fast-async/parallel-benchmark.svg)

æˆ‘ä»¬å°† `Promise.all` æ€§èƒ½æé«˜äº† **8 å€**ã€‚

ç„¶è€Œï¼Œä¸Šè¿°åŸºå‡†æµ‹è¯•æ˜¯åˆæˆçš„å°å‹åŸºå‡†ã€‚V8 å›¢é˜Ÿæ›´å…³å¿ƒæˆ‘ä»¬çš„ä¼˜åŒ–å¦‚ä½•å½±å“ [å®é™…ç”¨æˆ·ä»£ç çš„çœŸå®ä¸–ç•Œæ€§èƒ½](/blog/real-world-performance)ã€‚

![](/_img/fast-async/http-benchmarks.svg)

ä¸Šå›¾å¯è§†åŒ–äº†ä¸€äº›å¹¿æ³›ä½¿ç”¨çš„ HTTP ä¸­é—´ä»¶æ¡†æ¶çš„æ€§èƒ½ï¼Œè¿™äº›æ¡†æ¶å¤§é‡ä½¿ç”¨äº† Promise å’Œ `async` å‡½æ•°ã€‚è¯·æ³¨æ„ï¼Œæ­¤å›¾æ˜¾ç¤ºçš„æ˜¯æ¯ç§’çš„è¯·æ±‚æ•°ï¼Œå› æ­¤ä¸ä¹‹å‰çš„å›¾è¡¨ä¸åŒï¼Œæ•°å€¼è¶Šé«˜è¶Šå¥½ã€‚è¿™äº›æ¡†æ¶çš„æ€§èƒ½ä» Node.js 7 (V8 v5.5) åˆ° Node.js 10 (V8 v6.8) æ˜¾è‘—æé«˜ã€‚

è¿™äº›æ€§èƒ½æ”¹è¿›æ˜¯ä»¥ä¸‹ä¸‰ä¸ªå…³é”®æˆæœçš„ç»“æœï¼š

- [TurboFan](/docs/turbofan)ï¼Œæ–°çš„ä¼˜åŒ–ç¼–è¯‘å™¨ ğŸ‰
- [Orinoco](/blog/orinoco)ï¼Œæ–°çš„åƒåœ¾å›æ”¶å™¨ ğŸš›
- ä¸€ä¸ª Node.js 8 çš„ bug å¯¼è‡´ `await` è·³è¿‡å¾®ä»»åŠ¡ ğŸ›

æˆ‘ä»¬åœ¨ [Node.js 8 ä¸­å‘å¸ƒ TurboFan](/blog/launching-ignition-and-turbofan) æ—¶ï¼Œå¸¦æ¥äº†å…¨å±€å·¨å¤§çš„æ€§èƒ½æå‡ã€‚

æˆ‘ä»¬è¿˜å¼€å‘äº†ä¸€ä¸ªæ–°çš„åƒåœ¾å›æ”¶å™¨ï¼Œç§°ä¸º Orinocoï¼Œå°†åƒåœ¾æ”¶é›†å·¥ä½œä»ä¸»çº¿ç¨‹ç§»å¼€ï¼Œä»è€Œæ˜¾è‘—æé«˜äº†è¯·æ±‚å¤„ç†æ€§èƒ½ã€‚

æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼ŒNode.js 8 ä¸­å­˜åœ¨ä¸€ä¸ª bugï¼Œå¯¼è‡´ `await` åœ¨æŸäº›æƒ…å†µä¸‹è·³è¿‡å¾®ä»»åŠ¡ï¼Œä»è€Œæé«˜äº†æ€§èƒ½ã€‚è¿™ä¸ª bug æœ€åˆæ˜¯ä¸€ä¸ªæ— æ„çš„è§„èŒƒè¿èƒŒï¼Œä½†åæ¥æˆ‘ä»¬ä»ä¸­è·å¾—äº†ä¼˜åŒ–çš„çµæ„Ÿã€‚æˆ‘ä»¬ä»è§£é‡Šè¿™ä¸ªé”™è¯¯è¡Œä¸ºå¼€å§‹ï¼š

:::note
**æ³¨æ„ï¼š** ä»¥ä¸‹è¡Œä¸ºæ ¹æ®å†™ä½œæ—¶çš„ JavaScript è§„èŒƒæ˜¯æ­£ç¡®çš„ã€‚ä»é‚£æ—¶èµ·ï¼Œæˆ‘ä»¬çš„è§„èŒƒææ¡ˆè¢«æ¥å—ï¼Œä»¥ä¸‹â€œé”™è¯¯â€è¡Œä¸ºç°åœ¨æ˜¯æ­£ç¡®çš„ã€‚
:::

```js
const p = Promise.resolve();

(async () => {
  await p; console.log(&apos;after:await&apos;);
})();

p.then(() => console.log(&apos;tick:a&apos;))
 .then(() => console.log(&apos;tick:b&apos;));
```

ä¸Šé¢çš„ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ªå·²å®Œæˆçš„ Promise `p`ï¼Œå¹¶ `await` å®ƒçš„ç»“æœï¼ŒåŒæ—¶è¿˜é“¾æ¥äº†ä¸¤ä¸ªå¤„ç†ç¨‹åºã€‚åœ¨ä½ çœ‹æ¥ï¼Œ`console.log` çš„è°ƒç”¨ä¼šä»¥ä»€ä¹ˆé¡ºåºæ‰§è¡Œå‘¢ï¼Ÿ

ç”±äº `p` å·²å®Œæˆï¼Œä½ å¯èƒ½è®¤ä¸ºå®ƒä¼šå…ˆæ‰“å° `&apos;after:await&apos;`ï¼Œç„¶åæ˜¯ `&apos;tick&apos;`ã€‚äº‹å®ä¸Šï¼Œåœ¨ Node.js 8 ä¸­ç¡®å®å¦‚æ­¤ï¼š

![Node.js 8 ä¸­çš„ `await` bug](/_img/fast-async/await-bug-node-8.svg)

è™½ç„¶è¿™ç§è¡Œä¸ºçœ‹èµ·æ¥å¾ˆç›´è§‚ï¼Œä½†æ ¹æ®è§„èŒƒå®ƒæ˜¯ä¸æ­£ç¡®çš„ã€‚Node.js 10 å®ç°äº†æ­£ç¡®çš„è¡Œä¸ºï¼Œå³å…ˆæ‰§è¡Œå·²é“¾å¼è°ƒç”¨çš„å¤„ç†ç¨‹åºï¼Œç„¶åæ‰ç»§ç»­æ‰§è¡Œå¼‚æ­¥å‡½æ•°ã€‚

![Node.js 10 ä¸å†æœ‰ `await` bug](/_img/fast-async/await-bug-node-10.svg)

è¿™ç§ _â€œæ­£ç¡®è¡Œä¸ºâ€_ å¯ä»¥è¯´å¹¶ä¸ç«‹å³æ˜¾è€Œæ˜“è§ï¼Œç”šè‡³è®© JavaScript å¼€å‘è€…æ„Ÿåˆ°æƒŠè®¶ï¼Œå› æ­¤å€¼å¾—è§£é‡Šã€‚åœ¨æˆ‘ä»¬æ·±å…¥æ‰¿è¯ºå’Œå¼‚æ­¥å‡½æ•°çš„ç¥å¥‡ä¸–ç•Œä¹‹å‰ï¼Œè®©æˆ‘ä»¬ä»ä¸€äº›åŸºç¡€æ¦‚å¿µå¼€å§‹ã€‚

### ä»»åŠ¡ä¸å¾®ä»»åŠ¡

åœ¨é«˜å±‚æ¬¡ä¸Šï¼ŒJavaScript ä¸­æœ‰ _ä»»åŠ¡_ å’Œ _å¾®ä»»åŠ¡_ã€‚ä»»åŠ¡å¤„ç†äº‹ä»¶ï¼ˆä¾‹å¦‚ I/O å’Œå®šæ—¶å™¨ï¼‰ï¼Œä¸€æ¬¡æ‰§è¡Œä¸€ä¸ªã€‚å¾®ä»»åŠ¡å®ç°å»¶è¿Ÿæ‰§è¡Œï¼Œç”¨äº `async`/`await` å’Œ Promiseï¼Œå¹¶åœ¨æ¯ä¸ªä»»åŠ¡ç»“æŸæ—¶æ‰§è¡Œã€‚å¾®ä»»åŠ¡é˜Ÿåˆ—æ€»æ˜¯åœ¨æ‰§è¡Œè¿”å›åˆ°äº‹ä»¶å¾ªç¯ä¹‹å‰è¢«æ¸…ç©ºã€‚

![å¾®ä»»åŠ¡ä¸ä»»åŠ¡çš„åŒºåˆ«](/_img/fast-async/microtasks-vs-tasks.svg)

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ Jake Archibald çš„[æµè§ˆå™¨ä¸­çš„ä»»åŠ¡ã€å¾®ä»»åŠ¡ã€é˜Ÿåˆ—å’Œè°ƒåº¦](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)çš„è§£é‡Šã€‚Node.js çš„ä»»åŠ¡æ¨¡å‹éå¸¸ç›¸ä¼¼ã€‚

### å¼‚æ­¥å‡½æ•°

æ ¹æ® MDN çš„è¯´æ³•ï¼Œå¼‚æ­¥å‡½æ•°æ˜¯ä¸€ç§å¼‚æ­¥æ“ä½œçš„å‡½æ•°ï¼Œå®ƒä½¿ç”¨éšå¼çš„ Promise æ¥è¿”å›ç»“æœã€‚å¼‚æ­¥å‡½æ•°æ—¨åœ¨ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼Œä»è€Œéšè—ä¸€äº›å¼‚æ­¥å¤„ç†çš„å¤æ‚æ€§ã€‚

æœ€ç®€å•å¯èƒ½çš„å¼‚æ­¥å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
async function computeAnswer() {
  return 42;
}
```

è°ƒç”¨æ—¶è¿”å›ä¸€ä¸ª Promiseï¼Œå¯ä»¥åƒå¤„ç†å…¶ä»– Promise ä¸€æ ·è·å–å…¶å€¼ã€‚

```js
const p = computeAnswer();
// â†’ Promise

p.then(console.log);
// ä¸‹ä¸€è½®æ‰“å° 42
```

ä½ åªèƒ½åœ¨ä¸‹ä¸€æ¬¡è¿è¡Œå¾®ä»»åŠ¡æ—¶è·å¾—è¿™ä¸ª Promise `p` çš„å€¼ã€‚æ¢å¥è¯è¯´ï¼Œä¸Šè¿°ç¨‹åºåœ¨è¯­ä¹‰ä¸Šç­‰ä»·äºä½¿ç”¨ `Promise.resolve` å’Œè¿™ä¸ªå€¼ï¼š

```js
function computeAnswer() {
  return Promise.resolve(42);
}
```

å¼‚æ­¥å‡½æ•°çš„çœŸæ­£å¼ºå¤§ä¹‹å¤„åœ¨äº `await` è¡¨è¾¾å¼ï¼Œå®ƒä¼šå¯¼è‡´å‡½æ•°æš‚åœæ‰§è¡Œï¼Œç›´åˆ° Promise è¢«è§£æï¼Œç„¶åå†æ¢å¤æ‰§è¡Œã€‚`await` çš„å€¼å³ä¸ºè§£æåçš„ Promise çš„å€¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®ä¾‹è¯´æ˜äº†å…¶æ„ä¹‰ï¼š

```js
async function fetchStatus(url) {
  const response = await fetch(url);
  return response.status;
}
```

`fetchStatus` çš„æ‰§è¡Œä¼šåœ¨ `await` ä¸Šæš‚åœï¼Œéšååœ¨ `fetch` Promise å®Œæˆåæ¢å¤ã€‚è¿™åœ¨æŸç§ç¨‹åº¦ä¸Šç­‰åŒäºå°†ä¸€ä¸ªå¤„ç†ç¨‹åºé“¾æ¥åˆ° `fetch` è¿”å›çš„ Promiseã€‚

```js
function fetchStatus(url) {
  return fetch(url).then(response => response.status);
}
```

è¿™ä¸ªå¤„ç†ç¨‹åºåŒ…å«äº†å¼‚æ­¥å‡½æ•°ä¸­ `await` åçš„ä»£ç ã€‚

é€šå¸¸ï¼Œä½ ä¼šä¼ é€’ä¸€ä¸ª `Promise` ç»™ `await`ï¼Œä½†å®é™…ä¸Šä½ å¯ä»¥ç­‰å¾…ä»»æ„ JavaScript å€¼ã€‚å¦‚æœ `await` åçš„è¡¨è¾¾å¼å€¼ä¸æ˜¯ Promiseï¼Œåˆ™ä¼šå°†å…¶è½¬æ¢ä¸º Promiseã€‚è¿™æ„å‘³ç€å¦‚æœæ„¿æ„ï¼Œä½ ä¹Ÿå¯ä»¥ `await 42`ï¼š

```js
async function foo() {
  const v = await 42;
  return v;
}

const p = foo();
// â†’ Promise

p.then(console.log);
// æœ€ç»ˆæ‰“å° `42`
```

æ›´æœ‰è¶£çš„æ˜¯ï¼Œ`await` å¯ä»¥ä¸ä»»ä½•[â€œå¯ then åŒ–å¯¹è±¡â€](https://promisesaplus.com/) ä¸€èµ·ä½¿ç”¨ï¼Œå³ä»»ä½•å¸¦æœ‰ `then` æ–¹æ³•çš„å¯¹è±¡ï¼Œå³ä½¿å®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„ Promiseã€‚å› æ­¤ï¼Œä½ å¯ä»¥å®ç°ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ä¸€ä¸ªå¼‚æ­¥çš„ç¡çœ æ“ä½œï¼Œå®ƒæµ‹é‡å®é™…ç¡çœ æ—¶é—´ï¼š

```js
class Sleep {
  constructor(timeout) {
    this.timeout = timeout;
  }
  then(resolve, reject) {
    const startTime = Date.now();
    setTimeout(() => resolve(Date.now() - startTime),
               this.timeout);
  }
}

(async () => {
  const actualTime = await new Sleep(1000);
  console.log(actualTime);
})();
```

è®©æˆ‘ä»¬çœ‹çœ‹ V8 åœ¨å†…éƒ¨æ˜¯å¦‚ä½•å¤„ç† `await` çš„ï¼Œåœ¨éµå¾ª[è§„èŒƒ](https://tc39.es/ecma262/#await)çš„æƒ…å†µä¸‹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„å¼‚æ­¥å‡½æ•° `foo`ï¼š

```js
async function foo(v) {
  const w = await v;
  return w;
}
```

è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå°†å‚æ•° `v` åŒ…è£…æˆä¸€ä¸ª Promiseï¼Œå¹¶æš‚åœå¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œç›´åˆ°è¯¥ Promise è¢«è§£æã€‚ä¸€æ—¦å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå‡½æ•°çš„æ‰§è¡Œæ¢å¤ï¼Œ`w` è¢«èµ‹å€¼ä¸ºè§£æåçš„ Promise å€¼ã€‚éšåä»å¼‚æ­¥å‡½æ•°è¿”å›è¯¥å€¼ã€‚

### `await` çš„å†…éƒ¨å·¥ä½œåŸç†

é¦–å…ˆï¼ŒV8 å°†è¿™ä¸ªå‡½æ•°æ ‡è®°ä¸º_å¯æ¢å¤çš„_ï¼Œè¿™æ„å‘³ç€å¯ä»¥æš‚åœæ‰§è¡Œå¹¶ç¨åï¼ˆåœ¨ `await` ç‚¹ï¼‰æ¢å¤æ‰§è¡Œã€‚ç„¶åå®ƒåˆ›å»ºæ‰€è°“çš„ `implicit_promise`ï¼Œå³è°ƒç”¨å¼‚æ­¥å‡½æ•°æ—¶è¿”å›çš„ Promiseï¼Œæœ€ç»ˆè§£æä¸ºå¼‚æ­¥å‡½æ•°ç”Ÿæˆçš„å€¼ã€‚

![ç®€å•å¼‚æ­¥å‡½æ•°ä¸å¼•æ“è½¬æ¢åçš„å¯¹æ¯”å›¾](/_img/fast-async/await-under-the-hood.svg)

æ¥ä¸‹æ¥æ˜¯æœ‰è¶£çš„éƒ¨åˆ†ï¼šå®é™…çš„ `await`ã€‚é¦–å…ˆä¼ ç»™ `await` çš„å€¼ä¼šè¢«åŒ…è£…æˆä¸€ä¸ª Promiseã€‚ç„¶åï¼Œè¿™ä¸ªåŒ…è£…åçš„ Promise ä¼šè¢«é™„åŠ å¤„ç†ç¨‹åºï¼Œä»¥ä¾¿åœ¨ Promise å®Œæˆåæ¢å¤å‡½æ•°ï¼Œå¹¶æš‚åœå¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œå°† `implicit_promise` è¿”å›ç»™è°ƒç”¨è€…ã€‚ä¸€æ—¦ `promise` è¢«å®Œæˆï¼Œå¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œä¼šæ¢å¤ï¼Œä½¿ç”¨ `promise` ä¸­çš„å€¼ `w` å¹¶å°† `implicit_promise` è§£æä¸º `w`ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œ`await v` çš„åˆå§‹æ­¥éª¤æ˜¯ï¼š

1. å°†ä¼ é€’ç»™ `await` çš„å€¼ `v` åŒ…è£…æˆä¸€ä¸ª Promiseã€‚
2. é™„åŠ å¤„ç†ç¨‹åºä»¥ç¨åæ¢å¤å¼‚æ­¥å‡½æ•°ã€‚
3. æš‚åœå¼‚æ­¥å‡½æ•°å¹¶å°† `implicit_promise` è¿”å›ç»™è°ƒç”¨è€…ã€‚

è®©æˆ‘ä»¬é€æ­¥è§£æè¿™äº›æ“ä½œã€‚å‡è®¾ `await` æ“ä½œçš„å¯¹è±¡å·²ç»æ˜¯ä¸€ä¸ª Promiseï¼Œå¹¶ä¸”å·²è¢«è§£æä¸ºå€¼ `42`ã€‚ç„¶åå¼•æ“ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ `promise` å¹¶è§£æè¯¥ Promiseã€‚è¿™åœ¨ä¸‹ä¸€è½®ä¸­å®Œæˆè¿™äº› Promise çš„å»¶è¿Ÿé“¾æ¥ï¼Œç”±è§„èŒƒæ‰€è°“çš„ [`PromiseResolveThenableJob`](https://tc39.es/ecma262/#sec-promiseresolvethenablejob) æ¥è¡¨ç¤ºã€‚

![](/_img/fast-async/await-step-1.svg)

ç„¶åå¼•æ“ä¼šåˆ›å»ºå¦ä¸€ä¸ªæ‰€è°“çš„`ä¸´æ—¶`Promiseã€‚å®ƒè¢«ç§°ä¸º*ä¸´æ—¶çš„*ï¼Œå› ä¸ºå®ƒä»æœªè¢«é“¾å¼è°ƒç”¨â€”â€”å®ƒæ˜¯å¼•æ“å†…éƒ¨å®Œå…¨ä¸“ç”¨çš„ã€‚è¿™ç§`ä¸´æ—¶`Promiseç„¶åä¼šè¢«é“¾æ¥åˆ°åŸæ¥çš„`Promise`ä¸Šï¼Œå¹¶åŠ å…¥é€‚å½“çš„å¤„ç†ç¨‹åºä»¥æ¢å¤å¼‚æ­¥å‡½æ•°ã€‚è¿™ç§`performPromiseThen`æ“ä½œæœ¬è´¨ä¸Šå°±æ˜¯[`Promise.prototype.then()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then)åœ¨å¹•åæ‰€åšçš„äº‹æƒ…ã€‚æœ€åï¼Œå¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œè¢«æŒ‚èµ·ï¼Œæ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨è€…ã€‚

![](/_img/fast-async/await-step-2.svg)

æ‰§è¡Œåœ¨è°ƒç”¨è€…ä¸­ç»§ç»­ï¼Œæœ€ç»ˆè°ƒç”¨æ ˆå˜ç©ºã€‚ç„¶åJavaScriptå¼•æ“å¼€å§‹è¿è¡Œå¾®ä»»åŠ¡ï¼šå®ƒè¿è¡Œä¹‹å‰è°ƒåº¦çš„[`PromiseResolveThenableJob`](https://tc39.es/ecma262/#sec-promiseresolvethenablejob)ï¼Œéšåè°ƒåº¦æ–°çš„[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)å°†`Promise`é“¾æ¥åˆ°ä¼ é€’ç»™`await`çš„å€¼ã€‚ç„¶åï¼Œå¼•æ“è¿”å›ç»§ç»­å¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå› ä¸ºå¿…é¡»æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—åæ‰èƒ½ç»§ç»­ä¸»äº‹ä»¶å¾ªç¯ã€‚

![](/_img/fast-async/await-step-3.svg)

æ¥ä¸‹æ¥æ˜¯[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)ï¼Œå®ƒä½¿ç”¨æˆ‘ä»¬`await`çš„Promiseä¸­çš„å€¼ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸º`42`ï¼‰å®Œæˆ`Promise`ï¼Œå¹¶å°†ååº”è°ƒåº¦åˆ°`ä¸´æ—¶`Promiseã€‚ç„¶åå¼•æ“å†æ¬¡è¿”å›åˆ°å¾®ä»»åŠ¡å¾ªç¯ï¼Œå…¶ä¸­æœ€ååŒ…å«ä¸€ä¸ªéœ€è¦å¤„ç†çš„å¾®ä»»åŠ¡ã€‚

![](/_img/fast-async/await-step-4-final.svg)

ç°åœ¨ç¬¬äºŒä¸ª[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)å°†è§£å†³ç»“æœä¼ æ’­åˆ°`ä¸´æ—¶`Promiseï¼Œå¹¶æ¢å¤å¼‚æ­¥å‡½æ•°çš„æŒ‚èµ·æ‰§è¡Œï¼Œè¿”å›ä»`await`è·å–çš„å€¼`42`ã€‚

![`await`å¼€é”€çš„æ¦‚è¿°](/_img/fast-async/await-overhead.svg)

æ€»ç»“æˆ‘ä»¬æ‰€å­¦åˆ°çš„ï¼Œå¯¹äºæ¯ä¸ª`await`ï¼Œå¼•æ“å¿…é¡»é¢å¤–åˆ›å»º**ä¸¤ä¸ª**Promiseï¼ˆå³ä½¿å³è¾¹å·²ç»æ˜¯ä¸€ä¸ªPromiseï¼‰ï¼Œå¹¶ä¸”éœ€è¦**è‡³å°‘ä¸‰æ¬¡**å¾®ä»»åŠ¡é˜Ÿåˆ—è°ƒåº¦ã€‚è°ä¼šæƒ³åˆ°å•ä¸ª`await`è¡¨è¾¾å¼ä¼šå¸¦æ¥_å¦‚æ­¤å¤§çš„å¼€é”€_ï¼Ÿï¼

![](/_img/fast-async/await-code-before.svg)

è®©æˆ‘ä»¬çœ‹çœ‹è¿™äº›å¼€é”€çš„æ¥æºã€‚ç¬¬ä¸€è¡Œè´Ÿè´£åˆ›å»ºåŒ…è£…Promiseã€‚ç¬¬äºŒè¡Œç«‹å³å°†åŒ…è£…Promiseè§£æä¸º`await`çš„å€¼`v`ã€‚è¿™ä¸¤è¡Œè´Ÿè´£ä¸€ä¸ªé¢å¤–çš„PromiseåŠ ä¸Šä¸‰æ¬¡å¾®ä»»åŠ¡è°ƒåº¦ä¸­çš„ä¸¤æ¬¡ã€‚å¦‚æœ`v`å·²ç»æ˜¯Promiseï¼ˆè¿™æ˜¯å¸¸è§æƒ…å†µï¼Œå› ä¸ºåº”ç”¨é€šå¸¸åœ¨Promiseä¸Šæ‰§è¡Œ`await`ï¼‰ï¼Œè¿™ç®—æ˜¯è¾ƒé«˜çš„å¼€é”€ã€‚åœ¨å¼€å‘è€…ä¸å¤ªå¯èƒ½çš„æƒ…å†µä¸‹`await`ä¸€ä¸ªä¾‹å¦‚`42`çš„å€¼ï¼Œå¼•æ“ä»éœ€è¦å°†å…¶åŒ…è£…æˆPromiseã€‚

äº‹å®è¯æ˜ï¼Œè§„èŒƒä¸­å·²ç»æœ‰ä¸€ä¸ª[`promiseResolve`](https://tc39.es/ecma262/#sec-promise-resolve)æ“ä½œï¼Œåªåœ¨éœ€è¦æ—¶è¿›è¡ŒåŒ…è£…ï¼š

![](/_img/fast-async/await-code-comparison.svg)

è¯¥æ“ä½œç›´æ¥è¿”å›Promiseï¼Œå¯¹äºå…¶ä»–å€¼å¿…è¦æ—¶æ‰åŒ…è£…æˆPromiseã€‚è¿™æ ·ï¼Œåœ¨ä¼ é€’ç»™`await`çš„å€¼å·²ç»æ˜¯Promiseçš„å¸¸è§æƒ…å†µä¸‹ï¼Œå¯ä»¥èŠ‚çœä¸€ä¸ªé¢å¤–çš„PromiseåŠä¸¤ä¸ªå¾®ä»»åŠ¡è°ƒåº¦ã€‚è¿™ç§æ–°è¡Œä¸ºåœ¨[V8 v7.2ä¸­å·²ç»é»˜è®¤å¯ç”¨](/blog/v8-release-72#async%2Fawait)ã€‚å¯¹äºV8 v7.1ï¼Œå¯ä»¥ä½¿ç”¨`--harmony-await-optimization`é€‰é¡¹å¯ç”¨æ–°è¡Œä¸ºã€‚æˆ‘ä»¬å·²[å°†æ­¤æ›´æ”¹æè®®ä¸ºECMAScriptè§„èŒƒçš„ä¸€éƒ¨åˆ†](https://github.com/tc39/ecma262/pull/1250)ã€‚

ä»¥ä¸‹æ˜¯æ”¹è¿›åçš„`await`èƒŒåçš„å·¥ä½œåŸç†ï¼Œåˆ†æ­¥éª¤è¯´æ˜ï¼š

![](/_img/fast-async/await-new-step-1.svg)

å‡è®¾æˆ‘ä»¬å†æ¬¡`await`ä¸€ä¸ªè¢«è§£æä¸º`42`çš„Promiseã€‚å¤šäºäº†[`promiseResolve`](https://tc39.es/ecma262/#sec-promise-resolve)çš„é­”åŠ›ï¼Œç°åœ¨`Promise`ç›´æ¥å¼•ç”¨ç›¸åŒçš„Promise`v`ï¼Œå› æ­¤è¯¥æ­¥éª¤ä¸éœ€è¦åšä»»ä½•å¤„ç†ã€‚éšåå¼•æ“ç»§ç»­å¦‚ä¹‹å‰åˆ›å»º`ä¸´æ—¶`Promiseï¼Œè°ƒåº¦ä¸€ä¸ª [`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)ä»¥åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä¸‹ä¸€æ¬¡è°ƒåº¦ä¸­æ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼ŒæŒ‚èµ·å‡½æ•°çš„æ‰§è¡Œï¼Œå¹¶è¿”å›è°ƒç”¨è€…ã€‚

![](/_img/fast-async/await-new-step-2.svg)

æœ€ç»ˆå½“æ‰€æœ‰JavaScriptæ‰§è¡Œå®Œæˆåï¼Œå¼•æ“å¼€å§‹è¿è¡Œå¾®ä»»åŠ¡ä»¥æ‰§è¡Œ[`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)ã€‚æ­¤ä»»åŠ¡å°†`Promise`çš„è§£å†³ç»“æœä¼ æ’­åˆ°`ä¸´æ—¶`Promiseï¼Œå¹¶æ¢å¤å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œä»`await`ä¸­è¿”å›`42`ã€‚

![å‡å°‘`await`å¼€é”€çš„æ€»ç»“](/_img/fast-async/await-overhead-removed.svg)

æ­¤ä¼˜åŒ–é¿å…äº†åœ¨ä¼ é€’ç»™`await`çš„å€¼å·²ç»æ˜¯Promiseçš„æƒ…å†µä¸‹åˆ›å»ºåŒ…è£…Promiseçš„éœ€è¦ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»**è‡³å°‘ä¸‰æ¬¡**å¾®ä»»åŠ¡è°ƒåº¦å‡å°‘åˆ°ä»…å‰©**ä¸€æ¬¡**å¾®ä»»åŠ¡è°ƒåº¦ã€‚è¿™ç§è¡Œä¸ºä¸Node.js 8ç±»ä¼¼ï¼Œåªæ˜¯ç°åœ¨å®ƒä¸å†æ˜¯ä¸€ä¸ªé”™è¯¯â€”â€”è€Œæ˜¯æ­£åœ¨æ ‡å‡†åŒ–çš„ä¸€é¡¹ä¼˜åŒ–ï¼

ä»ç„¶æ„Ÿè§‰ä¸å¤ªå¯¹åŠ²çš„æ˜¯ï¼Œå°½ç®¡`ä¸´æ—¶`Promiseå®Œå…¨æ˜¯å¼•æ“å†…éƒ¨ä½¿ç”¨ï¼Œä½†å¼•æ“ä¸å¾—ä¸åˆ›å»ºå®ƒã€‚äº‹å®è¯æ˜ï¼Œ`ä¸´æ—¶`Promiseçš„å­˜åœ¨ä»…æ˜¯ä¸ºäº†æ»¡è¶³è§„èŒƒä¸­å†…éƒ¨`performPromiseThen`æ“ä½œçš„APIçº¦æŸã€‚

![](/_img/fast-async/await-optimized.svg)

æœ€è¿‘åœ¨å¯¹ECMAScriptè§„èŒƒçš„ä¸€æ¬¡[ç¼–è¾‘ä¿®æ”¹](https://github.com/tc39/ecma262/issues/694)ä¸­è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å¼•æ“ä¸å†éœ€è¦ä¸º`await`åˆ›å»º`throwaway` promise â€”â€” åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹[^2]ã€‚

[^2]: å¦‚æœåœ¨Node.jsä¸­ä½¿ç”¨äº†[`async_hooks`](https://nodejs.org/api/async_hooks.html)ï¼Œé‚£ä¹ˆV8ä»ç„¶éœ€è¦åˆ›å»º`throwaway` promiseï¼Œå› ä¸º`before`å’Œ`after`é’©å­ä¼šè¿è¡Œåœ¨`throwaway` promiseçš„ä¸Šä¸‹æ–‡ä¸­ã€‚

![ä¼˜åŒ–å‰å`await`ä»£ç çš„æ¯”è¾ƒ](/_img/fast-async/node-10-vs-node-12.svg)

å°†Node.js 10ä¸­çš„`await`ä¸å¯èƒ½å‡ºç°åœ¨Node.js 12ä¸­çš„ä¼˜åŒ–åçš„`await`è¿›è¡Œæ¯”è¾ƒï¼Œå±•ç¤ºäº†è¿™ä¸€æ›´æ”¹çš„æ€§èƒ½å½±å“ï¼š

![](/_img/fast-async/benchmark-optimization.svg)

**ç°åœ¨`async`/`await`çš„æ€§èƒ½è¶…è¿‡äº†æ‰‹å†™çš„Promiseä»£ç **ã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯æˆ‘ä»¬æ˜¾è‘—å‡å°‘äº†å¼‚æ­¥å‡½æ•°çš„å¼€é”€â€”â€”ä¸ä»…åœ¨V8ä¸­ï¼Œè€Œä¸”åœ¨æ‰€æœ‰JavaScriptå¼•æ“ä¸­ï¼Œé€šè¿‡ä¿®æ”¹è§„èŒƒå®ç°äº†è¿™ä¸€ç‚¹ã€‚

**æ›´æ–°ï¼š** ä»V8 v7.2å’ŒChrome 72å¼€å§‹ï¼Œ`--harmony-await-optimization`é»˜è®¤å¯ç”¨ã€‚[å¯¹ECMAScriptè§„èŒƒçš„è¡¥ä¸](https://github.com/tc39/ecma262/pull/1250)å·²è¢«åˆå¹¶ã€‚

## æ”¹è¿›å¼€å‘è€…ä½“éªŒ

é™¤äº†æ€§èƒ½å¤–ï¼ŒJavaScriptå¼€å‘è€…ä¹Ÿå…³å¿ƒè¯Šæ–­å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼Œè€Œåœ¨å¤„ç†å¼‚æ­¥ä»£ç æ—¶ï¼Œè¿™å¹¶ä¸æ€»æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚[Chrome DevTools](https://developers.google.com/web/tools/chrome-devtools)æ”¯æŒ*å¼‚æ­¥å †æ ˆè·Ÿè¸ª*ï¼Œå³ä¸ä»…åŒ…æ‹¬å †æ ˆçš„å½“å‰åŒæ­¥éƒ¨åˆ†ï¼Œè¿˜åŒ…æ‹¬å¼‚æ­¥éƒ¨åˆ†ï¼š

![](/_img/fast-async/devtools.png)

è¿™æ˜¯æœ¬åœ°å¼€å‘æœŸé—´ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ã€‚ç„¶è€Œï¼Œä¸€æ—¦åº”ç”¨éƒ¨ç½²ï¼Œè¿™ç§æ–¹æ³•å®é™…ä¸Šå¯¹ä½ æ²¡æœ‰å¸®åŠ©ã€‚åœ¨äº‹åè°ƒè¯•æœŸé—´ï¼Œä½ åªèƒ½åœ¨æ—¥å¿—æ–‡ä»¶ä¸­çœ‹åˆ°`Error#stack`çš„è¾“å‡ºï¼Œè¿™å¹¶ä¸èƒ½å‘Šè¯‰ä½ å…³äºå¼‚æ­¥éƒ¨åˆ†çš„ä»»ä½•ä¿¡æ¯ã€‚

æˆ‘ä»¬æœ€è¿‘åœ¨[é›¶æˆæœ¬å¼‚æ­¥å †æ ˆè·Ÿè¸ª](https://bit.ly/v8-zero-cost-async-stack-traces)ä¸Šè¿›è¡Œäº†ä¸€äº›å·¥ä½œï¼Œè¯¥åŠŸèƒ½å°†å¼‚æ­¥å‡½æ•°è°ƒç”¨ä¸°å¯Œåˆ°`Error#stack`å±æ€§ä¸­ã€‚â€œé›¶æˆæœ¬â€å¬èµ·æ¥å¾ˆæœ‰å¸å¼•åŠ›ï¼Œä¸æ˜¯å—ï¼Ÿå½“Chrome DevToolsåŠŸèƒ½å¸¦æ¥äº†å¤§é‡å¼€é”€æ—¶ï¼Œå¦‚ä½•èƒ½å¤Ÿæ˜¯é›¶æˆæœ¬ï¼Ÿè€ƒè™‘è¿™ä¸ªä¾‹å­ï¼Œ`foo`å¼‚æ­¥è°ƒç”¨`bar`ï¼Œè€Œ`bar`åœ¨`await`ä¸€ä¸ªPromiseåæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼š

```js
async function foo() {
  await bar();
  return 42;
}

async function bar() {
  await Promise.resolve();
  throw new Error(&apos;BEEP BEEP&apos;);
}

foo().catch(error => console.log(error.stack));
```

åœ¨Node.js 8æˆ–Node.js 10ä¸­è¿è¡Œè¿™æ®µä»£ç ä¼šå¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```text/2
$ node index.js
Error: BEEP BEEP
    at bar (index.js:8:9)
    at process._tickCallback (internal/process/next_tick.js:68:7)
    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)
    at startup (internal/bootstrap/node.js:266:19)
    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)
```

æ³¨æ„ï¼Œå°½ç®¡è°ƒç”¨`foo()`å¼•å‘äº†é”™è¯¯ï¼Œ`foo`æ ¹æœ¬ä¸åœ¨å †æ ˆè·Ÿè¸ªä¸­ã€‚è¿™ä½¿å¾—JavaScriptå¼€å‘è€…åœ¨äº‹åè°ƒè¯•æ—¶å˜å¾—å¤æ‚ï¼Œæ— è®ºä½ çš„ä»£ç æ˜¯éƒ¨ç½²åœ¨ç½‘é¡µåº”ç”¨è¿˜æ˜¯æŸäº›äº‘å®¹å™¨ä¸­ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œå¼•æ“çŸ¥é“`bar`å®Œæˆååº”è¯¥åœ¨å“ªé‡Œç»§ç»­ï¼šå°±æ˜¯å‡½æ•°`foo`ä¸­çš„`await`ä¹‹åçš„åœ°æ–¹ã€‚å·§åˆçš„æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯å‡½æ•°`foo`è¢«æŒ‚èµ·çš„ä½ç½®ã€‚å¼•æ“å¯ä»¥ä½¿ç”¨æ­¤ä¿¡æ¯é‡å»ºå¼‚æ­¥å †æ ˆè·Ÿè¸ªçš„éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯é‚£äº›`await`çš„ä½ç½®ã€‚åº”ç”¨æ­¤æ›´æ”¹åï¼Œè¾“å‡ºç»“æœå˜ä¸ºï¼š

```text/2,7
$ node --async-stack-traces index.js
Error: BEEP BEEP
    at bar (index.js:8:9)
    at process._tickCallback (internal/process/next_tick.js:68:7)
    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)
    at startup (internal/bootstrap/node.js:266:19)
    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)
    at async foo (index.js:2:3)
```

åœ¨å †æ ˆè·Ÿè¸ªä¸­ï¼Œæœ€é¡¶å±‚çš„å‡½æ•°æœ€å…ˆå‡ºç°ï¼Œç„¶åæ˜¯å…¶ä½™åŒæ­¥å †æ ˆè·Ÿè¸ªï¼Œæ¥ç€æ˜¯å¼‚æ­¥è°ƒç”¨å‡½æ•°`foo`ä¸­çš„`bar`ã€‚æ­¤æ›´æ”¹åœ¨V8ä¸­é€šè¿‡æ–°çš„`--async-stack-traces`æ ‡å¿—å®ç°ã€‚**æ›´æ–°ï¼š** ä»V8 v7.3å¼€å§‹ï¼Œ`--async-stack-traces`é»˜è®¤å¯ç”¨ã€‚

ç„¶è€Œï¼Œå¦‚æœæ‚¨å°†å…¶ä¸ä¸Šé¢ Chrome DevTools ä¸­çš„å¼‚æ­¥å †æ ˆè·Ÿè¸ªè¿›è¡Œæ¯”è¾ƒï¼Œæ‚¨ä¼šæ³¨æ„åˆ°å¼‚æ­¥å †æ ˆè·Ÿè¸ªä¸­ç¼ºå°‘å®é™…è°ƒç”¨ `foo` çš„ä½ç½®ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¯¥æ–¹æ³•åˆ©ç”¨äº† `await` çš„æ¢å¤å’ŒæŒ‚èµ·ä½ç½®ç›¸åŒçš„äº‹å®â€”â€”ä½†å¯¹äºå¸¸è§„çš„ [`Promise#then()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then) æˆ– [`Promise#catch()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch) è°ƒç”¨ï¼Œè¿™å¹¶ä¸æˆç«‹ã€‚æ›´å¤šèƒŒæ™¯ä¿¡æ¯è¯·å‚é˜… Mathias Bynens å…³äº[ä¸ºä»€ä¹ˆ `await` èƒœè¿‡ `Promise#then()`](https://mathiasbynens.be/notes/async-stack-traces)çš„è§£é‡Šã€‚

## ç»“è®º

æˆ‘ä»¬é€šè¿‡ä¸¤ä¸ªé‡è¦çš„ä¼˜åŒ–ä½¿å¾—å¼‚æ­¥å‡½æ•°è¿è¡Œæ›´å¿«ï¼š

- ç§»é™¤äº†ä¸¤ä¸ªé¢å¤–çš„å¾®ä»»åŠ¡ï¼Œä»¥åŠ
- ç§»é™¤äº† `throwaway` promiseã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œé€šè¿‡ [*é›¶æˆæœ¬å¼‚æ­¥å †æ ˆè·Ÿè¸ª*](https://bit.ly/v8-zero-cost-async-stack-traces) æå‡äº†å¼€å‘è€…çš„ä½“éªŒï¼Œé›¶æˆæœ¬å¼‚æ­¥å †æ ˆè·Ÿè¸ªæ”¯æŒå¼‚æ­¥å‡½æ•°ä¸­çš„ `await` å’Œ `Promise.all()`ã€‚

åŒæ—¶æˆ‘ä»¬è¿˜ä¸º JavaScript å¼€å‘è€…æä¾›äº†ä¸€äº›ä¸é”™çš„æ€§èƒ½å»ºè®®ï¼š

- ä¼˜å…ˆä½¿ç”¨ `async` å‡½æ•°å’Œ `await` è€Œéæ‰‹å†™çš„ promise ä»£ç ï¼Œä»¥åŠ
- ä½¿ç”¨ JavaScript å¼•æ“æä¾›çš„åŸç”Ÿ promise å®ç°ä»¥åˆ©ç”¨ä¼˜åŒ–æŠ€å·§ï¼Œä¾‹å¦‚é¿å… `await` éœ€è¦çš„ä¸¤ä¸ªå¾®ä»»åŠ¡ã€‚
