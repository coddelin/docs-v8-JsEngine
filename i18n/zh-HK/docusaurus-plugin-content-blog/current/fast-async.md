---
title: 'æ›´å¿«çš„éåŒæ­¥å‡½å¼èˆ‡ Promise'
author: 'Maya Armyanovaï¼ˆ[@Zmayski](https://twitter.com/Zmayski)ï¼‰ï¼Œæ°¸é è™•æ–¼ç­‰å¾…ç‹€æ…‹çš„é æ¸¬è€…ï¼Œä»¥åŠ Benedikt Meurerï¼ˆ[@bmeurer](https://twitter.com/bmeurer)ï¼‰ï¼Œå°ˆæ¥­æ€§èƒ½æ‰¿è«¾è€…'
avatars:
  - 'maya-armyanova'
  - 'benedikt-meurer'
date: 2018-11-12 16:45:07
tags:
  - ECMAScript
  - åŸºæº–æ¸¬è©¦
  - ç°¡å ±
description: 'æ›´å¿«ä¸”æ›´æ˜“æ–¼é™¤éŒ¯çš„éåŒæ­¥å‡½å¼èˆ‡ Promise å³å°‡æ–¼ V8 v7.2 / Chrome 72 æ¨å‡ºã€‚'
tweet: '1062000102909169670'
---
JavaScript ä¸­çš„éåŒæ­¥è™•ç†å‚³çµ±ä¸Šè¢«èªç‚ºé€Ÿåº¦ä¸¦ä¸ç‰¹åˆ¥å¿«ã€‚æ›´ç³Ÿçš„æ˜¯ï¼Œå°å³æ™‚é‹è¡Œçš„ JavaScript æ‡‰ç”¨é€²è¡Œé™¤éŒ¯â€”â€”å°¤å…¶æ˜¯ Node.js ä¼ºæœå™¨â€”â€”ä¸¦ä¸å®¹æ˜“ï¼Œ_ç‰¹åˆ¥æ˜¯_æ¶‰åŠéåŒæ­¥ç¨‹å¼æ™‚ã€‚ä¸éå¹¸é‹çš„æ˜¯ï¼Œæ™‚ä»£æ­£åœ¨æ”¹è®Šã€‚æœ¬æ–‡å°‡æ¢è¨æˆ‘å€‘å¦‚ä½•åœ¨ V8ï¼ˆä»¥åŠæŸç¨®ç¨‹åº¦ä¸Šå…¶ä»– JavaScript å¼•æ“ï¼‰ä¸­å„ªåŒ–éåŒæ­¥å‡½å¼èˆ‡ Promiseï¼Œä¸¦æè¿°æˆ‘å€‘å¦‚ä½•æ”¹é€²éåŒæ­¥ç¨‹å¼ç¢¼çš„é™¤éŒ¯é«”é©—ã€‚

<!--truncate-->
:::note
**æ³¨æ„ï¼š** å¦‚æœæ‚¨æ›´å–œæ­¡è§€çœ‹ç°¡å ±è€Œä¸æ˜¯é–±è®€æ–‡ç« ï¼Œè«‹æ¬£è³ä¸‹é¢çš„å½±ç‰‡ï¼å¦å‰‡ï¼Œè·³éå½±ç‰‡ç¹¼çºŒé–±è®€ã€‚
:::

<figure>
  <div class="video video-16:9">
    <iframe src="https://www.youtube.com/embed/DFP5DKDQfOc" width="640" height="360" loading="lazy"></iframe>
  </div>
</figure>

## éåŒæ­¥ç¨‹å¼è¨­è¨ˆçš„æ–°æ–¹æ³•

### å¾å›å‘¼åˆ° Promise å†åˆ°éåŒæ­¥å‡½å¼

åœ¨ Promise æˆç‚º JavaScript èªè¨€çš„ä¸€éƒ¨åˆ†ä¹‹å‰ï¼ŒåŸºæ–¼å›å‘¼çš„ API é€šå¸¸ç”¨æ–¼éåŒæ­¥ç¨‹å¼ç¢¼ï¼Œç‰¹åˆ¥æ˜¯åœ¨ Node.js ä¸­ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ç¯„ä¾‹ï¼š

```js
function handler(done) {
  validateParams((error) => {
    if (error) return done(error);
    dbQuery((error, dbResults) => {
      if (error) return done(error);
      serviceCall(dbResults, (error, serviceResults) => {
        console.log(result);
        done(error, serviceResults);
      });
    });
  });
}
```

ä»¥é€™ç¨®æ–¹å¼ä½¿ç”¨æ·±å±¤åµŒå¥—çš„å›å‘¼çš„ç‰¹å®šæ¨¡å¼é€šå¸¸è¢«ç¨±ç‚º_ã€Œå›å‘¼åœ°ç„ã€_ï¼Œå› ç‚ºå®ƒä½¿å¾—ç¨‹å¼ç¢¼çš„å¯è®€æ€§è®Šå·®ä¸”é›£ä»¥ç¶­è­·ã€‚

å¹¸é‹çš„æ˜¯ï¼Œç¾åœ¨ Promise å·²ç¶“æˆç‚º JavaScript èªè¨€çš„ä¸€éƒ¨åˆ†ï¼Œç›¸åŒçš„ç¨‹å¼ç¢¼å¯ä»¥ç”¨æ›´å„ªé›…ä¸”æ›´æ˜“æ–¼ç¶­è­·çš„æ–¹å¼æ’°å¯«ï¼š

```js
function handler() {
  return validateParams()
    .then(dbQuery)
    .then(serviceCall)
    .then(result => {
      console.log(result);
      return result;
    });
}
```

æ›´è¿‘ä¸€æ­¥ï¼ŒJavaScript ç²å¾—äº†[éåŒæ­¥å‡½å¼](https://web.dev/articles/async-functions)çš„æ”¯æ´ã€‚ä¸Šè¿°çš„éåŒæ­¥ç¨‹å¼ç¢¼ç¾åœ¨å¯ä»¥ç”¨é¡ä¼¼åŒæ­¥ç¨‹å¼ç¢¼çš„æ–¹å¼æ’°å¯«ï¼š

```js
async function handler() {
  await validateParams();
  const dbResults = await dbQuery();
  const results = await serviceCall(dbResults);
  console.log(results);
  return results;
}
```

æœ‰äº†éåŒæ­¥å‡½å¼ï¼Œç¨‹å¼ç¢¼è®Šå¾—æ›´åŠ ç°¡æ½”ï¼Œä¸¦ä¸”æ§åˆ¶å’Œè³‡æ–™æµä¹Ÿè®Šå¾—æ›´åŠ æ˜“æ–¼ç†è§£ï¼Œå„˜ç®¡åŸ·è¡Œä»ç„¶æ˜¯éåŒæ­¥çš„ã€‚ï¼ˆè«‹æ³¨æ„ JavaScript çš„åŸ·è¡Œä»ç„¶åœ¨å–®ä¸€åŸ·è¡Œç·’ä¸­ï¼Œé€™æ„å‘³è‘—éåŒæ­¥å‡½å¼æœ¬èº«ä¸¦æœªå»ºç«‹å¯¦éš›çš„åŸ·è¡Œç·’ã€‚ï¼‰

### å¾äº‹ä»¶ç›£è½å™¨å›å‘¼åˆ°éåŒæ­¥è¿­ä»£

å¦ä¸€ç¨®åœ¨ Node.js ä¸­ç‰¹åˆ¥å¸¸è¦‹çš„éåŒæ­¥ç¯„ä¾‹æ˜¯ [`ReadableStream`](https://nodejs.org/api/stream.html#stream_readable_streams)ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ä¾‹å­ï¼š

```js
const http = require('http');

http.createServer((req, res) => {
  let body = '';
  req.setEncoding('utf8');
  req.on('data', (chunk) => {
    body += chunk;
  });
  req.on('end', () => {
    res.write(body);
    res.end();
  });
}).listen(1337);
```

é€™æ®µç¨‹å¼ç¢¼å¯èƒ½æœ‰ä¸€é»é›£ä»¥ç†è§£ï¼šè¼¸å…¥çš„æ•¸æ“šåˆ†å¡Šè™•ç†åƒ…åœ¨å›å‘¼å…§éƒ¨å¯è¨ªå•ï¼Œä¸¦ä¸”æµçš„çµå°¾è¨Šè™Ÿä¹Ÿæ˜¯åœ¨å›å‘¼ä¸­è™•ç†ã€‚åœ¨å¿½ç•¥åŠŸèƒ½ç«‹å³çµ‚æ­¢ï¼Œä»¥åŠå¯¦éš›è™•ç†å¿…é ˆç™¼ç”Ÿåœ¨å›å‘¼ä¸­çš„æƒ…æ³ä¸‹ï¼Œå¾ˆå®¹æ˜“å¼•å…¥éŒ¯èª¤ã€‚

å¹¸å¥½ï¼Œä¸€å€‹ ES2018 çš„æ–°åŠŸèƒ½[éåŒæ­¥è¿­ä»£](http://2ality.com/2016/10/asynchronous-iteration.html)å¯ä»¥ç°¡åŒ–é€™æ®µç¨‹å¼ç¢¼ï¼š

```js
const http = require('http');

http.createServer(async (req, res) => {
  try {
    let body = '';
    req.setEncoding('utf8');
    for await (const chunk of req) {
      body += chunk;
    }
    res.write(body);
    res.end();
  } catch {
    res.statusCode = 500;
    res.end();
  }
}).listen(1337);
```

èˆ‡å…¶å°‡å¯¦éš›çš„è«‹æ±‚è™•ç†é‚è¼¯æ”¾ç½®åœ¨ `'data'` å’Œ `'end'` å›å‘¼ä¸­ï¼Œæˆ‘å€‘ç¾åœ¨å¯ä»¥å°‡æ‰€æœ‰é‚è¼¯æ”¾ç½®åœ¨å–®ä¸€çš„éåŒæ­¥å‡½å¼ä¸­ï¼Œä¸¦ä½¿ç”¨æ–°çš„ `for awaitâ€¦of` è¿´åœˆä¾†éåŒæ­¥åœ°è¿­ä»£é€™äº›åˆ†å¡Šã€‚æˆ‘å€‘é‚„åŠ å…¥äº†ä¸€å€‹ `try-catch` å€å¡Šä»¥é¿å… `unhandledRejection` å•é¡Œ[^1]ã€‚

[^1]: æ„Ÿè¬ [Matteo Collina](https://twitter.com/matteocollina) æŒ‡å¼•æˆ‘å€‘è‡³ [æ­¤å•é¡Œ](https://github.com/mcollina/make-promises-safe/blob/master/README.md#the-unhandledrejection-problem)ã€‚

ä½ ç¾åœ¨å°±å¯ä»¥åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨é€™äº›æ–°åŠŸèƒ½äº†ï¼ç•°æ­¥å‡½æ•¸åœ¨ **Node.js 8 (V8 v6.2 / Chrome 62)** ä¸­å·²å®Œå…¨æ”¯æŒï¼Œè€Œç•°æ­¥è¿­ä»£å™¨å’Œç”Ÿæˆå™¨åœ¨ **Node.js 10 (V8 v6.8 / Chrome 68)** ä¸­ä¹Ÿå·²å®Œå…¨æ”¯æŒï¼

## ç•°æ­¥æ€§èƒ½æ”¹é€²

æˆ‘å€‘åœ¨ V8 v5.5 (Chrome 55 & Node.js 7) å’Œ V8 v6.8 (Chrome 68 & Node.js 10) ä¹‹é–“ï¼Œé¡¯è‘—æå‡äº†ç•°æ­¥ç¨‹å¼ç¢¼çš„æ€§èƒ½ã€‚æˆ‘å€‘é”åˆ°äº†é€™æ¨£çš„æ€§èƒ½æ°´å¹³ï¼Œé–‹ç™¼è€…å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨é€™äº›æ–°çš„ç¨‹å¼è¨­è¨ˆç¯„å¼ï¼Œè€Œä¸ç”¨æ“”å¿ƒé€Ÿåº¦å•é¡Œã€‚

![](/_img/fast-async/doxbee-benchmark.svg)

ä¸Šåœ–é¡¯ç¤ºäº† [doxbee åŸºæº–æ¸¬è©¦](https://github.com/v8/promise-performance-tests/blob/master/lib/doxbee-async.js)ï¼Œè©²æ¸¬è©¦æ¸¬é‡äº†å¤§é‡ä½¿ç”¨ Promise çš„ç¨‹å¼ç¢¼æ€§èƒ½ã€‚è«‹æ³¨æ„ï¼Œåœ–è¡¨é¡¯ç¤ºäº†åŸ·è¡Œæ™‚é–“ï¼Œé€™æ„å‘³è‘—æ•¸å€¼è¶Šä½è¶Šå¥½ã€‚

åœ¨ [parallel åŸºæº–æ¸¬è©¦](https://github.com/v8/promise-performance-tests/blob/master/lib/parallel-async.js)ï¼ˆå°ˆé–€é‡å° [`Promise.all()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all) çš„æ€§èƒ½é€²è¡Œæ¸¬è©¦ï¼‰çš„çµæœæ›´åŠ ä»¤äººèˆˆå¥®ï¼š

![](/_img/fast-async/parallel-benchmark.svg)

æˆ‘å€‘æˆåŠŸå°‡ `Promise.all` çš„æ€§èƒ½æå‡äº† **8 å€**ã€‚

ç„¶è€Œï¼Œä»¥ä¸Šçš„åŸºæº–æ¸¬è©¦æ˜¯åˆæˆçš„å¾®å‹åŸºæº–æ¸¬è©¦ã€‚V8 åœ˜éšŠæ›´é—œæ³¨æˆ‘å€‘çš„å„ªåŒ–å¦‚ä½•å½±éŸ¿[å¯¦éš›ç”¨æˆ¶ç¨‹å¼ç¢¼çš„çœŸå¯¦æ€§èƒ½](/blog/real-world-performance)ã€‚

![](/_img/fast-async/http-benchmarks.svg)

ä¸Šåœ–å±•ç¤ºäº†ä¸€äº›è‘—åçš„ HTTP ä¸­é–“ä»¶æ¡†æ¶çš„æ€§èƒ½æ¸¬è©¦çµæœï¼Œé€™äº›æ¡†æ¶å¤§é‡ä½¿ç”¨äº† Promise å’Œ `async` å‡½æ•¸ã€‚è«‹æ³¨æ„ï¼Œæ­¤åœ–é¡¯ç¤ºäº†æ¯ç§’è™•ç†çš„è«‹æ±‚æ•¸ï¼Œèˆ‡å‰é¢çš„åœ–è¡¨ä¸åŒï¼Œæ•¸å€¼è¶Šé«˜è¶Šå¥½ã€‚å¾ Node.js 7 (V8 v5.5) åˆ° Node.js 10 (V8 v6.8)ï¼Œé€™äº›æ¡†æ¶çš„æ€§èƒ½å¾—åˆ°äº†é¡¯è‘—æé«˜ã€‚

é€™äº›æ€§èƒ½æ”¹é€²æ˜¯ä»¥ä¸‹ä¸‰é …é—œéµæˆå°±çš„çµæœï¼š

- [TurboFan](/docs/turbofan)ï¼Œå…¨æ–°çš„å„ªåŒ–ç·¨è­¯å™¨ ğŸ‰
- [Orinoco](/blog/orinoco)ï¼Œå…¨æ–°çš„åƒåœ¾å›æ”¶å™¨ ğŸš›
- Node.js 8 ä¸­çš„ä¸€å€‹ bugï¼Œè©² bug å°è‡´ `await` è·³é microticks ğŸ›

ç•¶æˆ‘å€‘åœ¨ [Node.js 8](https://medium.com/the-node-js-collection/node-js-8-3-0-is-now-available-shipping-with-the-ignition-turbofan-execution-pipeline-aa5875ad3367) ä¸­[æ¨å‡º TurboFan](/blog/launching-ignition-and-turbofan) æ™‚ï¼Œé€™ä½¿æ•´é«”æ€§èƒ½å¤§å¤§å¢å¼·ã€‚

æˆ‘å€‘é‚„ä¸€ç›´åœ¨é–‹ç™¼ä¸€å€‹åç‚º Orinoco çš„æ–°åƒåœ¾å›æ”¶å™¨ï¼Œè©²å›æ”¶å™¨å°‡åƒåœ¾å›æ”¶å·¥ä½œç§»è‡³ä¸»åŸ·è¡Œç·’ä¹‹å¤–ï¼Œå¾è€Œå¤§å¤§æå‡äº†è«‹æ±‚è™•ç†æ€§èƒ½ã€‚

æœ€å¾Œä½†åŒæ¨£é‡è¦çš„æ˜¯ï¼ŒNode.js 8 ä¸­æœ‰ä¸€å€‹æœ‰ç”¨çš„ bugï¼Œè©² bug å°è‡´ `await` åœ¨æŸäº›æƒ…æ³ä¸‹è·³é microticksï¼Œå¾è€Œæå‡äº†æ€§èƒ½ã€‚é€™å€‹ bug é–‹å§‹æ˜¯è¦ç¯„é•åï¼Œä½†å¾Œä¾†çµ¦äº†æˆ‘å€‘ä¸€å€‹å„ªåŒ–çš„æƒ³æ³•ã€‚æˆ‘å€‘å…ˆä¾†è§£é‡‹é€™å€‹éŒ¯èª¤çš„è¡Œç‚ºï¼š

:::note
**æ³¨æ„ï¼š**ä»¥ä¸‹è¡Œç‚ºåœ¨æ’°æ–‡æ™‚æŒ‰ç…§ JavaScript çš„è¦ç¯„æ˜¯æ­£ç¢ºçš„ã€‚è‡ªé‚£æ™‚ä»¥ä¾†ï¼Œæˆ‘å€‘çš„è¦ç¯„ææ¡ˆå·²è¢«æ¥å—ï¼Œä»¥ä¸‹çš„â€œéŒ¯èª¤â€è¡Œç‚ºç¾åœ¨æ˜¯æ­£ç¢ºçš„ã€‚
:::

```js
const p = Promise.resolve();

(async () => {
  await p; console.log('after:await');
})();

p.then(() => console.log('tick:a'))
 .then(() => console.log('tick:b'));
```

ä¸Šè¿°ç¨‹å¼ç¢¼å‰µå»ºäº†ä¸€å€‹å·²å®Œæˆçš„ Promise `p`ï¼Œä¸¦ `await` å®ƒçš„çµæœï¼ŒåŒæ™‚é‚„éˆæ¥äº†å…©å€‹è™•ç†å™¨åˆ°å®ƒä¸Šé¢ã€‚ä½ æœŸæœ›ä»¥ä»€éº¼é †åºåŸ·è¡Œ `console.log` èª¿ç”¨ï¼Ÿ

ç”±æ–¼ `p` å·²å®Œæˆï¼Œä½ å¯èƒ½æœŸæœ›å®ƒå…ˆæ‰“å° `'after:await'`ï¼Œç„¶å¾Œæ˜¯ `'tick'`ã€‚äº‹å¯¦ä¸Šï¼Œåœ¨ Node.js 8 ä¸­ä½ æœƒå¾—åˆ°é€™æ¨£çš„è¡Œç‚ºï¼š

![Node.js 8 ä¸­çš„ `await` éŒ¯èª¤](/_img/fast-async/await-bug-node-8.svg)

å„˜ç®¡æ­¤è¡Œç‚ºçœ‹èµ·ä¾†å¾ˆç›´è§€ï¼Œä½†æ ¹æ“šè¦ç¯„ï¼Œå®ƒä¸¦ä¸æ­£ç¢ºã€‚Node.js 10 å¯¦ç¾äº†æ­£ç¢ºçš„è¡Œç‚ºï¼Œä¹Ÿå°±æ˜¯é¦–å…ˆåŸ·è¡Œéˆæ¥çš„è™•ç†å™¨ï¼Œç„¶å¾Œæ‰ç¹¼çºŒåŸ·è¡Œç•°æ­¥å‡½æ•¸ã€‚

![Node.js 10 ä¸å†æœ‰ `await` çš„éŒ¯èª¤](/_img/fast-async/await-bug-node-10.svg)

é€™ç¨®_â€œæ­£ç¢ºè¡Œç‚ºâ€_å¯ä»¥èªªä¸¦ä¸é¦¬ä¸Šé¡¯è€Œæ˜“è¦‹ï¼Œå¯¦éš›ä¸Šå° JavaScript é–‹ç™¼è€…ä¾†èªªæ˜¯ä»¤äººé©šè¨çš„ï¼Œå› æ­¤å€¼å¾—èªªæ˜ã€‚åœ¨é€²å…¥ Promise å’Œç•°æ­¥å‡½æ•¸çš„é­”æ³•ä¸–ç•Œä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆäº†è§£ä¸€äº›åŸºç¤ã€‚

### ä»»å‹™èˆ‡å¾®ä»»å‹™

åœ¨é«˜å±¤æ¬¡ä¾†çœ‹ï¼ŒJavaScript ä¸­æœ‰_ä»»å‹™_å’Œ_å¾®ä»»å‹™_ã€‚ä»»å‹™è™•ç† I/O å’Œè¨ˆæ™‚å™¨ç­‰äº‹ä»¶ï¼Œä¸€æ¬¡åŸ·è¡Œä¸€å€‹ã€‚å¾®ä»»å‹™å¯¦ç¾ `async`/`await` å’Œ Promise çš„å»¶é²åŸ·è¡Œï¼Œä¸¦åœ¨æ¯å€‹ä»»å‹™çš„çµæŸåŸ·è¡Œã€‚å¾®ä»»å‹™éšŠåˆ—ç¸½æ˜¯åœ¨åŸ·è¡Œè¿”å›åˆ°äº‹ä»¶å¾ªç’°ä¹‹å‰æ¸…ç©ºã€‚

![å¾®ä»»å‹™èˆ‡ä»»å‹™ä¹‹é–“çš„å€åˆ¥](/_img/fast-async/microtasks-vs-tasks.svg)

æ¬²äº†è§£æ›´å¤šè©³ç´°ä¿¡æ¯ï¼Œè«‹æŸ¥çœ‹ Jake Archibald çš„ [ç€è¦½å™¨ä¸­çš„ä»»å‹™ã€å¾®ä»»å‹™ã€éšŠåˆ—å’Œæ’ç¨‹è§£é‡‹](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)ã€‚Node.js çš„ä»»å‹™æ¨¡å‹éå¸¸ç›¸ä¼¼ã€‚

### Async å‡½æ•¸

æ ¹æ“š MDN çš„èªªæ³•ï¼Œasync å‡½æ•¸æ˜¯ä¸€ç¨®åˆ©ç”¨éš±å¼ Promise ä»¥ç•°æ­¥æ–¹å¼è¿”å›çµæœçš„å‡½æ•¸ã€‚Async å‡½æ•¸æ—¨åœ¨ä½¿ç•°æ­¥ä»£ç¢¼çœ‹èµ·ä¾†åƒåŒæ­¥ä»£ç¢¼ä¸€æ¨£ï¼Œå¾è€Œéš±è—é–‹ç™¼è€…é¢è‡¨çš„ä¸€äº›ç•°æ­¥è™•ç†çš„è¤‡é›œæ€§ã€‚

æœ€ç°¡å–®çš„ async å‡½æ•¸çœ‹èµ·ä¾†æ˜¯é€™æ¨£çš„ï¼š

```js
async function computeAnswer() {
  return 42;
}
```

ç•¶èª¿ç”¨æ™‚ï¼Œå®ƒè¿”å›ä¸€å€‹ Promiseï¼Œæ‚¨å¯ä»¥åƒè™•ç†å…¶ä»– Promise ä¸€æ¨£ç²å–å…¶å€¼ã€‚

```js
const p = computeAnswer();
// â†’ Promise

p.then(console.log);
// åœ¨ä¸‹ä¸€å€‹å¾ªç’°ä¸­è¼¸å‡º 42
```

æ‚¨åªèƒ½åœ¨ä¸‹ä¸€æ¬¡é‹è¡Œå¾®ä»»å‹™æ™‚ç²å¾—è©² Promise `p` çš„å€¼ã€‚æ›å¥è©±èªªï¼Œä»¥ä¸Šç¨‹åºåœ¨èªç¾©ä¸Šç­‰åŒæ–¼ä½¿ç”¨ `Promise.resolve` å’Œè©²å€¼ï¼š

```js
function computeAnswer() {
  return Promise.resolve(42);
}
```

async å‡½æ•¸çš„çœŸæ­£åŠ›é‡ä¾†è‡ª `await` è¡¨é”å¼ï¼Œè©²è¡¨é”å¼æœƒä½¿å‡½æ•¸åŸ·è¡Œæš«åœï¼Œç›´åˆ° Promise è¢«è§£æ±ºï¼Œç„¶å¾Œåœ¨ Promise å±¥è¡Œå¾Œæ¢å¾©åŸ·è¡Œã€‚`await` çš„å€¼æ˜¯ Promise å±¥è¡Œå¾Œçš„å€¼ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹å±•ç¤ºé€™ä¸€å«ç¾©çš„ä¾‹å­ï¼š

```js
async function fetchStatus(url) {
  const response = await fetch(url);
  return response.status;
}
```

`fetchStatus` çš„åŸ·è¡Œåœ¨ `await` è™•è¢«æ›èµ·ï¼Œåœ¨ `fetch` çš„ Promise å±¥è¡Œå¾Œç¹¼çºŒåŸ·è¡Œã€‚é€™å¤šå°‘ç­‰åƒ¹æ–¼å°‡è™•ç†å™¨éˆæ¥åˆ° `fetch` è¿”å›çš„ Promiseã€‚

```js
function fetchStatus(url) {
  return fetch(url).then(response => response.status);
}
```

è©²è™•ç†å™¨åŒ…å« async å‡½æ•¸ä¸­ `await` ä¹‹å¾Œçš„ä»£ç¢¼ã€‚

é€šå¸¸æ‚¨æœƒå‘ `await` å‚³éä¸€å€‹ Promiseï¼Œä½†æ‚¨å¯¦éš›ä¸Šå¯ä»¥ç­‰å¾…ä»»ä½•ä»»æ„ JavaScript å€¼ã€‚å¦‚æœ `await` å¾Œé¢çš„è¡¨é”å¼çš„å€¼ä¸æ˜¯ Promiseï¼Œå‰‡å®ƒæœƒè¢«è½‰æ›ç‚º Promiseã€‚é€™æ„å‘³è‘—å¦‚æœæ‚¨æƒ³é€™éº¼åšï¼Œå¯ä»¥ `await 42`ï¼š

```js
async function foo() {
  const v = await 42;
  return v;
}

const p = foo();
// â†’ Promise

p.then(console.log);
// æœ€çµ‚è¼¸å‡º`42`
```

æ›´æœ‰è¶£çš„æ˜¯ï¼Œ`await` é©ç”¨æ–¼ä»»ä½• [`thenable`](https://promisesaplus.com/)ï¼Œå³ä»»ä½•æ“æœ‰ `then` æ–¹æ³•çš„å°è±¡ï¼Œå³ä½¿å®ƒä¸æ˜¯ä¸€å€‹çœŸæ­£çš„ Promiseã€‚æ‰€ä»¥æ‚¨å¯ä»¥å¯¦ç¾æœ‰è¶£çš„äº‹ï¼Œä¾‹å¦‚ä¸€å€‹æ¸¬é‡å¯¦éš›ç¡çœ æ™‚é–“çš„ç•°æ­¥ç¡çœ ï¼š

```js
class Sleep {
  constructor(timeout) {
    this.timeout = timeout;
  }
  then(resolve, reject) {
    const startTime = Date.now();
    setTimeout(() => resolve(Date.now() - startTime),
               this.timeout);
  }
}

(async () => {
  const actualTime = await new Sleep(1000);
  console.log(actualTime);
})();
```

è®“æˆ‘å€‘çœ‹çœ‹ V8 æ ¹æ“š [è¦ç¯„](https://tc39.es/ecma262/#await) åœ¨åº•å±¤å¦‚ä½•è™•ç† `await`ï¼Œä»¥ä¸‹æ˜¯ä¸€å€‹ç°¡å–®çš„ async å‡½æ•¸ `foo`ï¼š

```js
async function foo(v) {
  const w = await v;
  return w;
}
```

èª¿ç”¨æ™‚ï¼Œå®ƒå°‡åƒæ•¸ `v` åŒ…è£æˆ Promiseï¼Œä¸¦æš«åœ async å‡½æ•¸çš„åŸ·è¡Œï¼Œç›´åˆ°è©² Promise è§£æ±ºã€‚ä¸€æ—¦è§£æ±ºï¼Œå‡½æ•¸çš„åŸ·è¡Œæ¢å¾©ï¼Œ`w` è¢«åˆ†é…ç‚º Promise å±¥è¡Œçš„å€¼ã€‚é€™å€‹å€¼éš¨å¾Œå¾ async å‡½æ•¸è¿”å›ã€‚

### `await` çš„åº•å±¤é‹è¡Œæ©Ÿåˆ¶

é¦–å…ˆï¼ŒV8 å°‡æ­¤å‡½æ•¸æ¨™è¨˜ç‚º_å¯æ¢å¾©_ï¼Œé€™æ„å‘³è‘—å¯ä»¥æš«åœåŸ·è¡Œï¼Œç„¶å¾Œåœ¨ç¨å¾Œæ¢å¾©ï¼ˆåœ¨ `await` é»ï¼‰ã€‚ç„¶å¾Œï¼Œå®ƒå‰µå»ºä¸€å€‹ç¨±ç‚º `implicit_promise`ï¼ˆéš±å¼ Promiseï¼‰çš„å°è±¡ï¼Œè©² Promise æ˜¯ç•¶æ‚¨èª¿ç”¨ async å‡½æ•¸æ™‚è¿”å›çš„ï¼Œä¸¦æœ€çµ‚è§£æ±ºç‚ºç”± async å‡½æ•¸ç”Ÿæˆçš„å€¼ã€‚

![ç°¡å–® async å‡½æ•¸èˆ‡å¼•æ“å°‡å…¶è½‰åŒ–å¾Œçš„æ¯”è¼ƒ](/_img/fast-async/await-under-the-hood.svg)

ç„¶å¾Œä¾†åˆ°æœ‰è¶£çš„éƒ¨åˆ†ï¼šå¯¦éš›çš„ `await`ã€‚é¦–å…ˆï¼Œå‚³éçµ¦ `await` çš„å€¼è¢«åŒ…è£æˆä¸€å€‹ Promiseã€‚æ¥è‘—ï¼Œåœ¨è¢«åŒ…è£çš„ Promise ä¸Šé™„åŠ è™•ç†å™¨ï¼Œä»¥ä¾¿ Promise å±¥è¡Œå¾Œæ¢å¾©å‡½æ•¸çš„åŸ·è¡Œï¼Œè€Œ async å‡½æ•¸çš„åŸ·è¡Œæš«åœï¼Œå°‡ `implicit_promise` è¿”å›çµ¦èª¿ç”¨è€…ã€‚ä¸€æ—¦ Promise å±¥è¡Œï¼Œasync å‡½æ•¸çš„åŸ·è¡Œæ¢å¾©ï¼Œä¸¦ä½¿ç”¨ `promise` çš„å€¼ `w`ï¼ŒåŒæ™‚ `implicit_promise` ç”¨ `w` è§£æ±ºã€‚

ç°¡è€Œè¨€ä¹‹ï¼Œ`await v` çš„åˆå§‹æ­¥é©Ÿæ˜¯ï¼š

1. å°‡ `v`ï¼ˆå‚³éçµ¦ `await` çš„å€¼ï¼‰åŒ…è£æˆ Promiseã€‚
1. é™„åŠ è™•ç†å™¨ä»¥ä¾¿ç¨å¾Œæ¢å¾© async å‡½æ•¸ã€‚
1. æš«åœ async å‡½æ•¸ä¸¦å°‡ `implicit_promise` è¿”å›çµ¦èª¿ç”¨è€…ã€‚

è®“æˆ‘å€‘é€æ­¥è§£æå„é …æ“ä½œã€‚å‡è¨­è¢« `await` çš„å€¼å·²ç¶“æ˜¯ä¸€å€‹ Promiseï¼Œè©² Promise ç”¨å€¼ `42` å±¥è¡Œã€‚ä¹‹å¾Œå¼•æ“æœƒå‰µå»ºä¸€å€‹æ–°çš„ `promise`ï¼Œä¸¦ä½¿ç”¨è¢« `await` çš„å€¼å°å…¶é€²è¡Œè§£æ±ºã€‚é€™å€‹æ“ä½œåœ¨ä¸‹ä¸€æ¬¡è¼ªè½‰ä¸­å°é€™äº› Promise çš„å»¶é²éˆæ¥é€²è¡Œè¡¨é”ï¼Œæ ¹æ“šè¦ç¯„ç¨±ç‚º [`PromiseResolveThenableJob`](https://tc39.es/ecma262/#sec-promiseresolvethenablejob)ã€‚

![](/_img/fast-async/await-step-1.svg)

ç„¶å¾Œï¼ŒåŸ·è¡Œå¼•æ“å‰µå»ºå¦ä¸€å€‹æ‰€è¬‚çš„ `throwaway`ï¼ˆä¸€æ¬¡æ€§ï¼‰Promiseã€‚ä¹‹æ‰€ä»¥ç¨±ç‚ºã€Œä¸€æ¬¡æ€§ã€ï¼Œæ˜¯å› ç‚ºå®ƒå¾ä¾†ä¸æœƒè¢«éˆæ¥åˆ°å…¶ä»–æ±è¥¿â€”â€”å®ƒå®Œå…¨æ˜¯åŸ·è¡Œå¼•æ“å…§éƒ¨çš„æ“ä½œã€‚é€™å€‹ `throwaway` Promise ç„¶å¾Œæœƒè¢«éˆæ¥åˆ° `promise` ä¸Šï¼Œä¸¦å¸¶ä¸Šé©ç•¶çš„è™•ç†å™¨ä»¥æ¢å¾©ç•°æ­¥å‡½æ•¸çš„åŸ·è¡Œã€‚é€™å€‹ `performPromiseThen` æ“ä½œåŸºæœ¬ä¸Šå°±æ˜¯ [`Promise.prototype.then()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then) èƒŒå¾Œçš„å¯¦ç¾æ–¹å¼ã€‚æœ€å¾Œï¼Œç•°æ­¥å‡½æ•¸çš„åŸ·è¡Œè¢«æ›èµ·ï¼Œæ§åˆ¶æ¬Šè¿”å›çµ¦å‡½æ•¸èª¿ç”¨è€…ã€‚

![](/_img/fast-async/await-step-2.svg)

åŸ·è¡Œæœƒå›åˆ°èª¿ç”¨è€…ï¼Œæœ€çµ‚èª¿ç”¨å †ç–Šè®Šç©ºã€‚ç„¶å¾Œï¼ŒJavaScript å¼•æ“é–‹å§‹é‹è¡Œå¾®ä»»å‹™ï¼šå®ƒåŸ·è¡Œä¹‹å‰å®‰æ’çš„ [`PromiseResolveThenableJob`](https://tc39.es/ecma262/#sec-promiseresolvethenablejob)ï¼Œè©²ä»»å‹™æœƒå®‰æ’ä¸€å€‹æ–°çš„ [`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob) å°‡ `promise` éˆæ¥åˆ°å‚³éçµ¦ `await` çš„å€¼ä¸Šã€‚ç„¶å¾Œï¼Œå¼•æ“è¿”å›åˆ°å¾®ä»»å‹™éšŠåˆ—çš„è™•ç†ï¼Œå› ç‚ºå¾®ä»»å‹™éšŠåˆ—å¿…é ˆåœ¨ä¸»äº‹ä»¶å¾ªç’°ç¹¼çºŒä¹‹å‰æ¸…ç©ºã€‚

![](/_img/fast-async/await-step-3.svg)

æ¥ä¸‹ä¾†æ˜¯ [`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)ï¼Œå®ƒä½¿ç”¨æˆ‘å€‘æ­£åœ¨ `await` çš„ Promise çš„å€¼ä¾†å±¥è¡Œ `promise` â€”â€” åœ¨æ­¤ä¾‹ä¸­æ˜¯ `42` â€”â€” ä¸¦å°‡é€™å€‹åæ‡‰æ·»åŠ åˆ° `throwaway` Promise ä¸Šã€‚ç„¶å¾Œï¼Œå¼•æ“å†æ¬¡è¿”å›åˆ°å¾®ä»»å‹™å¾ªç’°ï¼Œè£¡é¢åŒ…å«æœ€å¾Œä¸€å€‹å¾…è™•ç†çš„å¾®ä»»å‹™ã€‚

![](/_img/fast-async/await-step-4-final.svg)

ç¾åœ¨ç¬¬äºŒå€‹ [`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob) å°‡è§£æ±ºæ–¹æ¡ˆå‚³éçµ¦ `throwaway` Promiseï¼Œä¸¦æ¢å¾©ç•°æ­¥å‡½æ•¸çš„æ›èµ·åŸ·è¡Œï¼Œå¾ `await` è¿”å›å€¼ `42`ã€‚

![`await` é–‹éŠ·çš„ç¸½çµåœ–è¡¨](/_img/fast-async/await-overhead.svg)

ç¸½çµæˆ‘å€‘å­¸åˆ°çš„å…§å®¹ï¼Œæ¯å€‹ `await` éƒ½è¦æ±‚åŸ·è¡Œå¼•æ“å‰µå»º**å…©å€‹é¡å¤–çš„** Promiseï¼ˆå³ä½¿å³å´å·²ç¶“æ˜¯ä¸€å€‹ Promiseï¼‰ï¼Œä¸¦ä¸”éœ€è¦**è‡³å°‘ä¸‰å€‹**å¾®ä»»å‹™éšŠåˆ—è¨ˆæ•¸ã€‚èª°æœƒæƒ³åˆ°ä¸€å€‹ç°¡å–®çš„ `await` è¡¨é”å¼ç«Ÿç„¶æœƒå¸¶ä¾†é€™éº¼å¤§çš„é–‹éŠ·ï¼Ÿï¼

![](/_img/fast-async/await-code-before.svg)

è®“æˆ‘å€‘ä¾†çœ‹çœ‹é€™äº›é–‹éŠ·æ˜¯å¾å“ªè£¡ä¾†çš„ã€‚ç¬¬ä¸€è¡Œè² è²¬å‰µå»ºåŒ…è£ Promiseã€‚ç¬¬äºŒè¡Œç«‹å³ç”¨ `await` çš„å€¼ `v` è§£æ±ºè©² Promiseã€‚é€™å…©è¡Œå¼•å…¥äº†ä¸€å€‹é¡å¤–çš„ Promise å’Œä¸‰å€‹å¾®ä»»å‹™è¨ˆæ•¸ä¸­çš„å…©å€‹ã€‚å¦‚æœ `v` å·²ç¶“æ˜¯ä¸€å€‹ Promiseï¼ˆé€™æ˜¯æœ€å¸¸è¦‹çš„æƒ…æ³ï¼Œå› ç‚ºæ‡‰ç”¨é€šå¸¸æœƒ `await` åœ¨ Promise ä¸Šï¼‰ï¼Œé€™å°±æœƒç›¸ç•¶æ˜‚è²´ã€‚åœ¨é–‹ç™¼è€…å°‘è¦‹åœ° `await` ä¾‹å¦‚ `42` é€™ç¨®å€¼çš„æƒ…æ³ä¸‹ï¼Œå¼•æ“ä»é ˆå°‡æ­¤å€¼åŒ…è£ç‚ºä¸€å€‹ Promiseã€‚

äº‹å¯¦è­‰æ˜ï¼Œåœ¨è¦ç¯„ä¸­å·²ç¶“å­˜åœ¨ä¸€å€‹ [`promiseResolve`](https://tc39.es/ecma262/#sec-promise-resolve) æ“ä½œï¼Œå®ƒåƒ…åœ¨éœ€è¦æ™‚åŸ·è¡ŒåŒ…è£æ“ä½œï¼š

![](/_img/fast-async/await-code-comparison.svg)

æ­¤æ“ä½œæœƒå°‡ Promise ä¿æŒä¸è®Šï¼Œä¸¦åƒ…æŒ‰éœ€å°‡å…¶ä»–å€¼åŒ…è£ç‚º Promiseã€‚é€™æ¨£ï¼Œå°±å¯ä»¥ç‚ºå‚³éçµ¦ `await` çš„å€¼å·²ç¶“æ˜¯ Promise çš„å¸¸è¦‹æƒ…æ³ç¯€çœä¸€å€‹é¡å¤–çš„ Promiseï¼Œä¸¦åŠ é€Ÿå…©æ¬¡å¾®ä»»å‹™éšŠåˆ—è¨ˆæ•¸ã€‚åœ¨ V8 v7.2 ä¸­ï¼Œ[æ­¤æ–°è¡Œç‚ºå·²é»˜èªå•Ÿç”¨](/blog/v8-release-72#async%2Fawait)ã€‚å°æ–¼ V8 v7.1ï¼Œå¯ä»¥ä½¿ç”¨ `--harmony-await-optimization` æ¨™èªŒå•Ÿç”¨æ–°è¡Œç‚ºã€‚æˆ‘å€‘å·²[å»ºè­°å°‡è©²æ›´æ”¹æ·»åŠ åˆ° ECMAScript è¦ç¯„ä¸­](https://github.com/tc39/ecma262/pull/1250)ã€‚

ä»¥ä¸‹æ˜¯æ–°æ”¹é€²çš„ `await` çš„å·¥ä½œæ–¹å¼ï¼Œå®ƒèƒŒå¾Œçš„åˆ†æ­¥æ“ä½œï¼š

![](/_img/fast-async/await-new-step-1.svg)

å‡è¨­æˆ‘å€‘å†æ¬¡ `await` ä¸€å€‹å·²å±¥è¡Œç‚º `42` çš„ Promiseã€‚ç”±æ–¼ [`promiseResolve`](https://tc39.es/ecma262/#sec-promise-resolve) çš„ç¥å¥‡ï¼Œ`promise` ç¾åœ¨åƒ…å¼•ç”¨èˆ‡ `v` ç›¸åŒçš„ Promiseï¼Œå› æ­¤é€™ä¸€æ­¥ä¸éœ€è¦åŸ·è¡Œä»»ä½•æ“ä½œã€‚ä¹‹å¾Œï¼ŒåŸ·è¡Œå¼•æ“å°±å’Œä»¥å‰å®Œå…¨ä¸€æ¨£ï¼Œå‰µå»º `throwaway` Promiseï¼Œå®‰æ’ä¸€å€‹ [`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob) åœ¨å¾®ä»»å‹™éšŠåˆ—çš„ä¸‹ä¸€æ¬¡ç¯€æ‹ä¸­æ¢å¾©ç•°æ­¥å‡½æ•¸ï¼Œæ›èµ·å‡½æ•¸çš„åŸ·è¡Œï¼Œä¸¦è¿”å›èª¿ç”¨è€…ã€‚

![](/_img/fast-async/await-new-step-2.svg)

æœ€çµ‚ç•¶æ‰€æœ‰ JavaScript åŸ·è¡Œå®Œæˆå¾Œï¼ŒåŸ·è¡Œå¼•æ“é–‹å§‹é‹è¡Œå¾®ä»»å‹™ï¼Œå› æ­¤å®ƒæœƒåŸ·è¡Œ [`PromiseReactionJob`](https://tc39.es/ecma262/#sec-promisereactionjob)ã€‚é€™å€‹ä»»å‹™å°‡ `promise` çš„è§£æ±ºå‚³éçµ¦ `throwaway`ï¼Œä¸¦æ¢å¾©ç•°æ­¥å‡½æ•¸çš„åŸ·è¡Œï¼Œå¾ `await` å¾—åˆ°çµæœ `42`ã€‚

![`await` é–‹éŠ·æ¸›å°‘çš„ç¸½çµåœ–è¡¨](/_img/fast-async/await-overhead-removed.svg)

é€™é …å„ªåŒ–é¿å…äº†ç•¶å‚³éçµ¦ `await` çš„å€¼å·²ç¶“æ˜¯ä¸€å€‹ Promise æ™‚ï¼Œå¿…é ˆå‰µå»ºä¸€å€‹åŒ…è£ Promise çš„å¿…è¦æ€§ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘å¾è‡³å°‘**ä¸‰å€‹**å¾®ä»»å‹™è¨ˆæ•¸é™è‡³åªæœ‰**ä¸€å€‹**ã€‚é€™ç¨®è¡Œç‚ºé¡ä¼¼æ–¼ Node.js 8 ä¸­çš„æƒ…æ³ï¼Œä½†ç¾åœ¨å®ƒä¸å†æ˜¯ä¸€å€‹éŒ¯èª¤â€”â€”è€Œæ˜¯ä¸€å€‹æ­£åœ¨æ¨™æº–åŒ–çš„å„ªåŒ–ï¼

ä»¤äººæ„Ÿè¦ºå¥‡æ€ªçš„æ˜¯ï¼Œå„˜ç®¡ `throwaway` Promise å®Œå…¨æ˜¯åŸ·è¡Œå¼•æ“å…§éƒ¨çš„å¯¦ç¾ï¼Œä½†åŸ·è¡Œå¼•æ“ä»é ˆå‰µå»ºè©² Promiseã€‚äº‹å¯¦è­‰æ˜ï¼Œ`throwaway` Promise åªæ˜¯ç”¨æ–¼æ»¿è¶³è¦ç¯„ä¸­å…§éƒ¨ `performPromiseThen` æ“ä½œçš„ API ç´„æŸã€‚

![](/_img/fast-async/await-optimized.svg)

é€™å€‹å•é¡Œæœ€è¿‘å·²åœ¨ECMAScriptè¦ç¯„çš„ä¸€æ¬¡[ç·¨è¼¯æ€§ä¿®æ”¹](https://github.com/tc39/ecma262/issues/694)ä¸­å¾—åˆ°äº†è™•ç†ã€‚å¼•æ“åœ¨å¤§å¤šæ•¸æƒ…æ³ä¸‹[^2]å·²ä¸å†éœ€è¦ç‚º`await`å‰µå»º`throwaway` promiseã€‚

[^2]: å¦‚æœåœ¨Node.jsä¸­ä½¿ç”¨[`async_hooks`](https://nodejs.org/api/async_hooks.html)ï¼ŒV8ä»éœ€è¦å‰µå»º`throwaway` promiseï¼Œå› ç‚º`before`å’Œ`after`é‰¤å­æ˜¯åœ¨`throwaway` promiseçš„ä¸Šä¸‹æ–‡ä¸­é‹è¡Œçš„ã€‚

![å°æ¯”å„ªåŒ–å‰å¾Œ`await`ä»£ç¢¼çš„å°æ¯”åœ–](/_img/fast-async/node-10-vs-node-12.svg)

å°‡Node.js 10ä¸­çš„`await`èˆ‡å¯èƒ½å‡ºç¾åœ¨Node.js 12ä¸­çš„ç¶“å„ªåŒ–çš„`await`é€²è¡Œæ¯”è¼ƒï¼Œå¯ä»¥é¡¯ç¤ºå‡ºæ­¤æ›´æ”¹çš„æ€§èƒ½å½±éŸ¿ï¼š

![](/_img/fast-async/benchmark-optimization.svg)

**ç¾åœ¨`async`/`await`çš„æ€§èƒ½å·²è¶…éæ‰‹å¯«çš„Promiseä»£ç¢¼**ã€‚é€™è£¡çš„ä¸»è¦çµè«–æ˜¯æˆ‘å€‘é¡¯è‘—æ¸›å°‘äº†ç•°æ­¥å‡½æ•¸çš„é–‹éŠ·â€”â€”é€™ä¸åƒ…é™æ–¼V8ï¼Œè€Œä¸”è·¨æ‰€æœ‰JavaScriptå¼•æ“çš†é©ç”¨ï¼Œé€™å¾—ç›Šæ–¼è¦ç¯„çš„ä¿®è£œã€‚

**æ›´æ–°ï¼š** å¾V8 v7.2å’ŒChrome 72é–‹å§‹ï¼Œ`--harmony-await-optimization`é»˜èªå·²å•Ÿç”¨ã€‚[è©²è£œä¸](https://github.com/tc39/ecma262/pull/1250)å·²è¢«åˆä½µåˆ°ECMAScriptè¦ç¯„ä¸­ã€‚

## æ”¹å–„çš„é–‹ç™¼è€…é«”é©—

é™¤äº†æ€§èƒ½ä¹‹å¤–ï¼ŒJavaScripté–‹ç™¼è€…é‚„é—œæ³¨è¨ºæ–·å’Œä¿®å¾©å•é¡Œçš„èƒ½åŠ›ï¼Œè€Œé€™åœ¨è™•ç†ç•°æ­¥ä»£ç¢¼æ™‚ä¸¦ä¸ç¸½æ˜¯å®¹æ˜“çš„ã€‚[Chrome DevTools](https://developers.google.com/web/tools/chrome-devtools)æ”¯æŒ*ç•°æ­¥èª¿ç”¨æ£§è¿½è¸ª*ï¼Œå³åŒ…å«ç•¶å‰åŒæ­¥æ£§éƒ¨åˆ†åŠç•°æ­¥éƒ¨åˆ†çš„èª¿ç”¨æ£§ï¼š

![](/_img/fast-async/devtools.png)

é€™åœ¨æœ¬åœ°é–‹ç™¼éç¨‹ä¸­æ˜¯ä¸€å€‹éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ã€‚ç„¶è€Œï¼Œé€™ç¨®æ–¹æ³•åœ¨æ‡‰ç”¨ç¨‹åºéƒ¨ç½²å¾Œä¸¦ä¸èƒ½çœŸæ­£å¹«åŠ©åˆ°ä½ ã€‚åœ¨äº‹å¾Œèª¿è©¦æ™‚ï¼Œä½ åªèƒ½åœ¨æ—¥èªŒæ–‡ä»¶ä¸­çœ‹åˆ°`Error#stack`çš„è¼¸å‡ºï¼Œé€™ä¸¦ä¸èƒ½å‘Šè¨´ä½ æœ‰é—œç•°æ­¥éƒ¨åˆ†çš„ä»»ä½•ä¿¡æ¯ã€‚

æˆ‘å€‘æœ€è¿‘åœ¨ç ”ç©¶[*é›¶æˆæœ¬ç•°æ­¥æ£§è¿½è¸ª*](https://bit.ly/v8-zero-cost-async-stack-traces)ï¼Œå®ƒç‚º`Error#stack`å±¬æ€§å¢åŠ äº†å°ç•°æ­¥å‡½æ•¸èª¿ç”¨çš„æ”¯æŒã€‚â€œé›¶æˆæœ¬â€è½èµ·ä¾†å¾ˆä»¤äººæ¿€å‹•ï¼Œä¸æ˜¯å—ï¼Ÿé‚£éº¼ç•¶Chrome DevToolsåŠŸèƒ½æœ‰é¡¯è‘—é–‹éŠ·æ™‚ï¼Œå®ƒæ€éº¼èƒ½æ˜¯é›¶æˆæœ¬çš„å‘¢ï¼Ÿè€ƒæ…®ä»¥ä¸‹å ´æ™¯ï¼Œå…¶ä¸­`foo`ç•°æ­¥èª¿ç”¨äº†`bar`ï¼Œè€Œ`bar`åœ¨ä½¿ç”¨`await`ç­‰å¾…ä¸€å€‹Promiseå¾Œæ‹‹å‡ºäº†ç•°å¸¸ï¼š

```js
async function foo() {
  await bar();
  return 42;
}

async function bar() {
  await Promise.resolve();
  throw new Error('BEEP BEEP');
}

foo().catch(error => console.log(error.stack));
```

åœ¨Node.js 8æˆ–Node.js 10ä¸­é‹è¡Œæ­¤ä»£ç¢¼æœƒå°è‡´ä»¥ä¸‹è¼¸å‡ºï¼š

```text/2
$ node index.js
Error: BEEP BEEP
    at bar (index.js:8:9)
    at process._tickCallback (internal/process/next_tick.js:68:7)
    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)
    at startup (internal/bootstrap/node.js:266:19)
    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)
```

æ³¨æ„ï¼Œé›–ç„¶èª¿ç”¨`foo()`å°è‡´äº†éŒ¯èª¤ï¼Œä½†`foo`å®Œå…¨ä¸åœ¨èª¿ç”¨æ£§ä¸­ã€‚é€™ä½¿å¾—JavaScripté–‹ç™¼è€…åœ¨äº‹å¾Œèª¿è©¦æ™‚è®Šå¾—å›°é›£ï¼Œç„¡è«–ä½ çš„ä»£ç¢¼æ˜¯éƒ¨ç½²åœ¨Webæ‡‰ç”¨ç¨‹åºä¸­é‚„æ˜¯éƒ¨ç½²åœ¨æŸäº›é›²å®¹å™¨å…§ã€‚

é€™è£¡æœ‰è¶£çš„ä¸€é»æ˜¯å¼•æ“çŸ¥é“å®ƒåœ¨`bar`å®Œæˆå¾Œéœ€è¦å¾å“ªè£¡ç¹¼çºŒï¼šå³`foo`å‡½æ•¸ä¸­çš„`await`ä¹‹å¾Œçš„åœ°æ–¹ã€‚å·§åˆçš„æ˜¯ï¼Œé‚£ä¹Ÿæ˜¯å‡½æ•¸`foo`è¢«æš«åœçš„åœ°æ–¹ã€‚å¼•æ“å¯ä»¥ä½¿ç”¨æ­¤ä¿¡æ¯ä¾†é‡æ§‹ç•°æ­¥èª¿ç”¨æ£§çš„éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯`await`å‡ºç¾çš„ä½ç½®ã€‚æœ‰äº†é€™äº›æ›´æ”¹ï¼Œè¼¸å‡ºè®Šç‚ºï¼š

```text/2,7
$ node --async-stack-traces index.js
Error: BEEP BEEP
    at bar (index.js:8:9)
    at process._tickCallback (internal/process/next_tick.js:68:7)
    at Function.Module.runMain (internal/modules/cjs/loader.js:745:11)
    at startup (internal/bootstrap/node.js:266:19)
    at bootstrapNodeJSCore (internal/bootstrap/node.js:595:3)
    at async foo (index.js:2:3)
```

åœ¨èª¿ç”¨æ£§ä¸­ï¼Œæœ€é ‚éƒ¨çš„å‡½æ•¸æœ€å…ˆå‡ºç¾ï¼Œå…¶å¾Œæ˜¯å‰©é¤˜çš„åŒæ­¥èª¿ç”¨æ£§ï¼Œæœ€å¾Œæ˜¯å‡½æ•¸`foo`ä¸­ç•°æ­¥èª¿ç”¨`bar`çš„éƒ¨åˆ†ã€‚æ­¤æ›´æ”¹åœ¨V8ä¸­é€šéæ–°å¼•å…¥çš„`--async-stack-traces`æ¨™èªŒå¯¦ç¾ã€‚**æ›´æ–°ï¼š** è‡ªV8 v7.3èµ·ï¼Œ`--async-stack-traces`é»˜èªå·²å•Ÿç”¨ã€‚

ä¸éï¼Œå¦‚æœä½ å°‡æ­¤èˆ‡ä¸Šé¢ Chrome Developer Tools ä¸­çš„éåŒæ­¥å †ç–Šè·Ÿè¹¤é€²è¡Œæ¯”è¼ƒï¼Œä½ æœƒæ³¨æ„åˆ°å †ç–Šè·Ÿè¹¤ä¸­éåŒæ­¥éƒ¨åˆ†ç¼ºå°‘å¯¦éš›çš„ `foo` èª¿ç”¨ä½ç½®ã€‚å¦‚å‰æ‰€è¿°ï¼Œé€™ç¨®æ–¹æ³•åˆ©ç”¨äº† `await` çš„æ¢å¾©å’Œæš«åœä½ç½®æ˜¯ç›¸åŒçš„é€™ä¸€äº‹å¯¦ â€”â€” ä½†å°æ–¼æ™®é€šçš„ [`Promise#then()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then) æˆ– [`Promise#catch()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch) èª¿ç”¨ï¼Œæƒ…æ³ä¸¦éå¦‚æ­¤ã€‚æ›´å¤šèƒŒæ™¯çŸ¥è­˜å¯é–±è®€ Mathias Bynens çš„è§£é‡‹ï¼š[ç‚ºä»€éº¼ `await` å‹é `Promise#then()`](https://mathiasbynens.be/notes/async-stack-traces)ã€‚

## çµè«–

æˆ‘å€‘é€šéå…©é …é‡å¤§å„ªåŒ–ä½¿éåŒæ­¥å‡½æ•¸æ›´å¿«ï¼š

- ç§»é™¤äº†å…©å€‹é¡å¤–çš„å¾®åˆ»ï¼ŒåŠ
- ç§»é™¤äº† `throwaway` æ‰¿è«¾ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘å€‘é€šé[*é›¶æˆæœ¬éåŒæ­¥å †ç–Šè·Ÿè¹¤*](https://bit.ly/v8-zero-cost-async-stack-traces) æ”¹å–„äº†é–‹ç™¼è€…çš„é«”é©—ï¼Œè©²ç‰¹æ€§å¯èˆ‡éåŒæ­¥å‡½æ•¸ä¸­çš„ `await` å’Œ `Promise.all()` ä¸€èµ·ä½¿ç”¨ã€‚

æˆ‘å€‘é‚„ç‚º JavaScript é–‹ç™¼è€…æä¾›äº†ä¸€äº›ä¸éŒ¯çš„æ€§èƒ½å»ºè­°ï¼š

- å„ªå…ˆä½¿ç”¨ `async` å‡½æ•¸å’Œ `await`ï¼Œè€Œä¸æ˜¯æ‰‹å¯«çš„æ‰¿è«¾ä»£ç¢¼ï¼ŒåŠ
- éµå¾ª JavaScript å¼•æ“æä¾›çš„æœ¬åœ°æ‰¿è«¾å¯¦ç¾ï¼Œä»¥å—ç›Šæ–¼å¿«æ·æ–¹å¼ï¼Œä¾‹å¦‚ï¼Œé¿å… `await` çš„å…©å€‹å¾®åˆ»ã€‚
