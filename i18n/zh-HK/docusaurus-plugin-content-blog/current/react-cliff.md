---
title: &apos;åœ¨ React ä¸­ V8 æ€§èƒ½å´–çš„æ•…äº‹&apos;
author: &apos;Benedikt Meurer ([@bmeurer](https://twitter.com/bmeurer)) å’Œ Mathias Bynens ([@mathias](https://twitter.com/mathias))&apos;
avatars:
  - &apos;benedikt-meurer&apos;
  - &apos;mathias-bynens&apos;
date: 2019-08-28 16:45:00
tags:
  - internals
  - presentations
description: &apos;æœ¬æ–‡æ•˜è¿° V8 å¦‚ä½•ç‚ºå„ç¨® JavaScript å€¼é¸æ“‡æœ€ä½³çš„å…§å­˜è¡¨ç¤ºæ–¹å¼ï¼Œä»¥åŠé€™å¦‚ä½•å½±éŸ¿å½¢ç‹€æ©Ÿåˆ¶â€”â€”é€™æœ‰åŠ©æ–¼è§£é‡‹æœ€è¿‘åœ¨ React æ ¸å¿ƒä¸­å‡ºç¾çš„ V8 æ€§èƒ½å´–ã€‚&apos;
tweet: &apos;1166723359696130049&apos;
---
[ä¹‹å‰](https://mathiasbynens.be/notes/shapes-ics)ï¼Œæˆ‘å€‘è¨è«–äº† JavaScript å¼•æ“å¦‚ä½•é€šéä½¿ç”¨å½¢ç‹€å’Œå…§ç·šå¿«å–ä¾†å„ªåŒ–ç‰©ä»¶å’Œæ•¸çµ„è¨ªå•ï¼Œä¸¦æ¢ç´¢äº†[å¼•æ“å¦‚ä½•åŠ é€ŸåŸå‹å±¬æ€§è¨ªå•](https://mathiasbynens.be/notes/prototypes)ã€‚æœ¬æ–‡æ•˜è¿° V8 å¦‚ä½•ç‚ºå„ç¨® JavaScript å€¼é¸æ“‡æœ€ä½³çš„å…§å­˜è¡¨ç¤ºæ–¹å¼ï¼Œä»¥åŠé€™å¦‚ä½•å½±éŸ¿å½¢ç‹€æ©Ÿåˆ¶â€”â€”é€™æœ‰åŠ©æ–¼è§£é‡‹[React æ ¸å¿ƒä¸­æœ€è¿‘çš„ V8 æ€§èƒ½å´–](https://github.com/facebook/react/issues/14365)ã€‚

<!--truncate-->
:::note
**æ³¨æ„:** å¦‚æœæ‚¨æ›´å–œæ­¡è§€çœ‹å±•ç¤ºè€Œéé–±è®€æ–‡ç« ï¼Œè«‹æ¬£è³ä¸‹é¢çš„è¦–é »ï¼å¦‚æœä¸æ„Ÿèˆˆè¶£ï¼Œå‰‡è·³éè¦–é »ç¹¼çºŒé–±è®€ã€‚
:::

<figure>
  <div class="video video-16:9">
    <iframe src="https://www.youtube.com/embed/0I0d8LkDqyc" width="640" height="360" loading="lazy" allowfullscreen></iframe>
  </div>
  <figcaption><a href="https://www.youtube.com/watch?v=0I0d8LkDqyc">â€œJavaScript å¼•æ“çš„åŸºæœ¬åŸç†ï¼šå¥½çš„ã€å£çš„å’Œé†œçš„â€</a>ï¼Œç”± Mathias Bynens å’Œ Benedikt Meurer åœ¨ AgentConf 2019 ä¸Šå±•ç¤ºã€‚</figcaption>
</figure>

## JavaScript é¡å‹

æ¯å€‹ JavaScript å€¼éƒ½æœ‰ä¸”åƒ…æœ‰ä¸€å€‹ï¼ˆç›®å‰ç‚ºæ­¢ï¼‰å…«ç¨®é¡å‹ä¹‹ä¸€ï¼š`Number`ï¼Œ`String`ï¼Œ`Symbol`ï¼Œ`BigInt`ï¼Œ`Boolean`ï¼Œ`Undefined`ï¼Œ`Null` å’Œ `Object`ã€‚

![](/_img/react-cliff/01-javascript-types.svg)

é™¤äº†æ˜é¡¯çš„ä¾‹å¤–ï¼Œé€™äº›é¡å‹å¯ä»¥é€šé JavaScript ä¸­çš„ `typeof` é‹ç®—ç¬¦è§€å¯Ÿåˆ°ï¼š

```js
typeof 42;
// â†’ &apos;number&apos;
typeof &apos;foo&apos;;
// â†’ &apos;string&apos;
typeof Symbol(&apos;bar&apos;);
// â†’ &apos;symbol&apos;
typeof 42n;
// â†’ &apos;bigint&apos;
typeof true;
// â†’ &apos;boolean&apos;
typeof undefined;
// â†’ &apos;undefined&apos;
typeof null;
// â†’ &apos;object&apos; ğŸ¤”
typeof { x: 42 };
// â†’ &apos;object&apos;
```

`typeof null` è¿”å› `&apos;object&apos;`ï¼Œè€Œä¸æ˜¯ `&apos;null&apos;`ï¼Œå„˜ç®¡ `Null` æ˜¯å®ƒè‡ªå·±çš„é¡å‹ã€‚è¦ç†è§£åŸå› ï¼Œè«‹è€ƒæ…®æ‰€æœ‰ JavaScript é¡å‹çš„é›†åˆåˆ†ç‚ºå…©çµ„ï¼š

- _objects_ï¼ˆå³ `Object` é¡å‹ï¼‰
- _primitives_ï¼ˆå³ä»»ä½•éç‰©ä»¶çš„å€¼ï¼‰

å› æ­¤ï¼Œ`null` è¡¨ç¤ºâ€œæ²’æœ‰ç‰©ä»¶å€¼â€ï¼Œè€Œ `undefined` è¡¨ç¤ºâ€œæ²’æœ‰å€¼â€ã€‚

![](/_img/react-cliff/02-primitives-objects.svg)

å¾ªè‘—é€™ç¨®æ€æƒ³ï¼ŒBrendan Eich è¨­è¨ˆäº† JavaScript ä½¿å¾— `typeof` è¿”å› `&apos;object&apos;` çµ¦å³å´çš„æ‰€æœ‰å€¼ï¼Œå³æ‰€æœ‰ç‰©ä»¶å’Œ `null` å€¼ï¼Œä»¥ç¬¦åˆ Java çš„ç²¾ç¥ã€‚é€™å°±æ˜¯ç‚ºä»€éº¼ `typeof null === &apos;object&apos;`ï¼Œå„˜ç®¡è¦ç¯„ä¸­æœ‰ä¸€å€‹ç¨ç«‹çš„ `Null` é¡å‹ã€‚

![](/_img/react-cliff/03-primitives-objects-typeof.svg)

## å€¼çš„è¡¨ç¤º

JavaScript å¼•æ“å¿…é ˆèƒ½å¤ åœ¨å…§å­˜ä¸­è¡¨ç¤ºä»»æ„çš„ JavaScript å€¼ã€‚ç„¶è€Œï¼Œé‡è¦çš„ä¸€é»æ˜¯ï¼Œå€¼çš„ JavaScript é¡å‹èˆ‡ JavaScript å¼•æ“å¦‚ä½•åœ¨å…§å­˜ä¸­è¡¨ç¤ºè©²å€¼æ˜¯åˆ†é–‹çš„ã€‚

ä¾‹å¦‚ï¼Œå€¼ `42` åœ¨ JavaScript ä¸­çš„é¡å‹ç‚º `number`ã€‚

```js
typeof 42;
// â†’ &apos;number&apos;
```

æœ‰å¹¾ç¨®æ–¹æ³•å¯ä»¥åœ¨å…§å­˜ä¸­è¡¨ç¤ºæ•´æ•¸å€¼ `42`ï¼š

:::table-wrapper
| è¡¨ç¤ºæ–¹å¼                           | ä½å…ƒ                                                                              |
| --------------------------------- | --------------------------------------------------------------------------------- |
| äºŒçš„è£œç¢¼ 8 ä½å…ƒ                  | `0010 1010`                                                                       |
| äºŒçš„è£œç¢¼ 32 ä½å…ƒ                 | `0000 0000 0000 0000 0000 0000 0010 1010`                                         |
| å°åŒ…äºŒé€²åˆ¶ç·¨ç¢¼çš„åé€²åˆ¶ (BCD)      | `0100 0010`                                                                       |
| 32 ä½å…ƒ IEEE-754 æµ®é»æ•¸          | `0100 0010 0010 1000 0000 0000 0000 0000`                                         |
| 64 ä½å…ƒ IEEE-754 æµ®é»æ•¸          | `0100 0000 0100 0101 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000` |
:::

ECMAScript å°‡æ•¸å­—æ¨™æº–åŒ–ç‚º 64 ä½å…ƒæµ®é»æ•¸ï¼Œä¹Ÿç¨±ç‚º_é›™ç²¾åº¦æµ®é»æ•¸_æˆ–_Float64_ã€‚ç„¶è€Œï¼Œé€™ä¸¦ä¸æ„å‘³è‘— JavaScript å¼•æ“ç¸½æ˜¯ä»¥ Float64 è¡¨ç¤ºæ•¸å­—â€”â€”é€™æ¨£åšæœƒéå¸¸ä½æ•ˆï¼å¼•æ“å¯ä»¥é¸æ“‡å…¶ä»–å…§éƒ¨è¡¨ç¤ºæ–¹å¼ï¼Œåªè¦è¡Œç‚ºä¸Šèˆ‡ Float64 ç²¾ç¢ºåŒ¹é…å³å¯ã€‚

å¤§å¤šæ•¸åœ¨çœŸå¯¦ä¸–ç•Œçš„ JavaScript æ‡‰ç”¨ä¸­ä½¿ç”¨çš„æ•¸å­—ï¼Œé€šå¸¸æ˜¯[æœ‰æ•ˆçš„ ECMAScript é™£åˆ—ç´¢å¼•](https://tc39.es/ecma262/#array-index)ï¼Œå³ä»‹æ–¼ 0 åˆ° 2Â³Â²âˆ’2 ç¯„åœå…§çš„æ•´æ•¸å€¼ã€‚

```js
array[0]; // æœ€å°å¯èƒ½çš„é™£åˆ—ç´¢å¼•ã€‚
array[42];
array[2**32-2]; // æœ€å¤§å¯èƒ½çš„é™£åˆ—ç´¢å¼•ã€‚
```

JavaScript å¼•æ“å¯ä»¥ç‚ºæ­¤é¡å‹çš„æ•¸å­—é¸æ“‡æœ€ä½³çš„å…§å­˜è¡¨ç¤ºæ–¹å¼ï¼Œä»¥å„ªåŒ–é€éç´¢å¼•å­˜å–é™£åˆ—å…ƒç´ çš„ç¨‹å¼ç¢¼ã€‚å°æ–¼è™•ç†å™¨åŸ·è¡Œå…§å­˜å­˜å–æ“ä½œï¼Œé™£åˆ—ç´¢å¼•å¿…é ˆä»¥[äºŒè£œæ•¸](https://en.wikipedia.org/wiki/Two%27s_complement)è¡¨ç¤ºã€‚è‹¥æ˜¯æ”¹ç”¨ Float64 è¡¨ç¤ºé™£åˆ—ç´¢å¼•å°‡æœƒéå¸¸æµªè²»ï¼Œå› ç‚ºå¼•æ“æ¯æ¬¡å­˜å–é™£åˆ—å…ƒç´ æ™‚ï¼Œå¿…é ˆåœ¨ Float64 èˆ‡äºŒè£œæ•¸ä¹‹é–“ä¾†å›è½‰æ›ã€‚

32 ä½äºŒè£œæ•¸è¡¨ç¤ºæ³•ä¸åƒ…åƒ…å°é™£åˆ—æ“ä½œæœ‰ç”¨ã€‚ä¸€èˆ¬ä¾†èªªï¼Œ**è™•ç†å™¨åŸ·è¡Œæ•´æ•¸æ“ä½œçš„é€Ÿåº¦é å¿«æ–¼æµ®é»æ“ä½œ**ã€‚é€™å°±æ˜¯ç‚ºä»€éº¼åœ¨ä»¥ä¸‹ç¯„ä¾‹ä¸­ï¼Œç¬¬ä¸€å€‹è¿´åœˆæ˜é¡¯æ¯”ç¬¬äºŒå€‹è¿´åœˆå¿«ä¸Šè‡³å°‘ä¸€å€ã€‚

```js
for (let i = 0; i < 1000; ++i) {
  // å¿« ğŸš€
}

for (let i = 0.1; i < 1000.1; ++i) {
  // æ…¢ ğŸŒ
}
```

åŒæ¨£çš„æƒ…æ³é©ç”¨æ–¼æ“ä½œã€‚ä»¥ä¸‹ç¨‹å¼ç¢¼ä¸­ï¼Œå–æ¨¡é‹ç®—ç¬¦çš„æ•ˆèƒ½å–æ±ºæ–¼æ‰€æ“ä½œçš„æ•´æ•¸æ˜¯å¦ç‚ºæ•´æ•¸ã€‚

```js
const remainder = value % divisor;
// å°æ–¼ `value` å’Œ `divisor` è¡¨ç¤ºç‚ºæ•´æ•¸ï¼Œé€Ÿåº¦å¿« ğŸš€ï¼Œ
// å¦å‰‡é€Ÿåº¦æ…¢ ğŸŒã€‚
```

å¦‚æœå…©å€‹æ“ä½œå…ƒè¢«è¡¨ç¤ºç‚ºæ•´æ•¸ï¼ŒCPU å°±èƒ½é«˜æ•ˆåœ°è¨ˆç®—çµæœã€‚V8 åœ¨ `divisor` æ˜¯äºŒçš„å†ªæ™‚ï¼Œé‚„æœ‰é¡å¤–çš„å¿«é€Ÿè™•ç†é€”å¾‘ã€‚è‹¥æ•¸å€¼è¡¨ç¤ºç‚ºæµ®é»æ•¸ï¼Œè¨ˆç®—å‰‡æœƒæ›´åŠ è¤‡é›œä¸”è€—æ™‚å¾—å¤šã€‚

ç”±æ–¼æ•´æ•¸æ“ä½œé€šå¸¸æ¯”æµ®é»æ“ä½œåŸ·è¡Œå¾—æ›´å¿«ï¼Œä¼¼ä¹å¼•æ“å¯ä»¥å§‹çµ‚ä½¿ç”¨äºŒè£œæ•¸ä¾†è¡¨ç¤ºæ‰€æœ‰æ•´æ•¸åŠæ‰€æœ‰æ•´æ•¸æ“ä½œçš„çµæœã€‚ä¸å¹¸çš„æ˜¯ï¼Œé€™å°‡é•å ECMAScript è¦ç¯„ï¼ECMAScript æ¨™æº–åŒ–ç‚º Float64ï¼Œå› æ­¤**æŸäº›æ•´æ•¸æ“ä½œå¯¦éš›ä¸Šæœƒç”¢ç”Ÿæµ®é»æ•¸**ã€‚åœ¨é€™äº›æƒ…æ³ä¸‹ï¼Œå¼•æ“å¿…é ˆç”¢å‡ºæ­£ç¢ºçš„çµæœã€‚

```js
// Float64 çš„å®‰å…¨æ•´æ•¸ç¯„åœæ˜¯ 53 ä½å…ƒã€‚è¶…å‡ºè©²ç¯„åœå¾Œï¼Œ
// ä½ å¿…é ˆå¤±å»ç²¾åº¦ã€‚
2**53 === 2**53+1;
// â†’ true

// Float64 æ”¯æ´è² é›¶ï¼Œå› æ­¤ -1 * 0 å¿…é ˆæ˜¯ -0ï¼Œ
// ä½†äºŒè£œæ•¸ä¸­ç„¡æ³•è¡¨ç¤ºè² é›¶ã€‚
-1*0 === -0;
// â†’ true

// Float64 æœ‰ç„¡çª®å¤§ï¼Œå¯ä»¥é€šéé™¤ä»¥é›¶ä¾†ç”¢ç”Ÿã€‚
1/0 === Infinity;
// â†’ true
-1/0 === -Infinity;
// â†’ true

// Float64 ä¹Ÿæœ‰ NaNsã€‚
0/0 === NaN;
```

å³ä½¿å·¦å´çš„å€¼æ˜¯æ•´æ•¸ï¼Œæ‰€æœ‰å³å´çš„å€¼éƒ½æ˜¯æµ®é»æ•¸ã€‚é€™å°±æ˜¯ç‚ºä»€éº¼ä¸Šè¿°æ“ä½œç„¡æ³•ä½¿ç”¨ 32 ä½å…ƒäºŒè£œæ•¸æ­£ç¢ºåŸ·è¡Œã€‚JavaScript å¼•æ“å¿…é ˆç‰¹åˆ¥æ³¨æ„è®“æ•´æ•¸æ“ä½œé©ç•¶å›é€€ä»¥ç”¢ç”Ÿ Float64 çš„é€²éšçµæœã€‚

å°æ–¼ 31 ä½å…ƒæœ‰ç¬¦è™Ÿæ•´æ•¸ç¯„åœå…§çš„å°æ•´æ•¸ï¼ŒV8 ä½¿ç”¨ä¸€ç¨®ç‰¹æ®Šè¡¨ç¤ºæ–¹å¼ï¼Œç¨±ç‚º `Smi`ã€‚ä»»ä½•ä¸å±¬æ–¼ `Smi` çš„éƒ½è¡¨ç¤ºç‚º `HeapObject`ï¼Œå³å…§å­˜ä¸­æŸäº›å¯¦é«”çš„åœ°å€ã€‚å°æ–¼æ•¸å­—ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€ç¨®ç‰¹æ®Šçš„ `HeapObject`ï¼Œç¨±ç‚º `HeapNumber`ï¼Œä¾†è¡¨ç¤ºä¸åœ¨ `Smi` ç¯„åœå…§çš„æ•¸å­—ã€‚

```js
 -Infinity // HeapNumber
-(2**30)-1 // HeapNumber
  -(2**30) // Smi
       -42 // Smi
        -0 // HeapNumber
         0 // Smi
       4.2 // HeapNumber
        42 // Smi
   2**30-1 // Smi
     2**30 // HeapNumber
  Infinity // HeapNumber
       NaN // HeapNumber
```

å¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œæœ‰äº› JavaScript çš„æ•¸å­—è¢«è¡¨ç¤ºç‚º `Smi`ï¼Œè€Œæœ‰äº›å‰‡è¢«è¡¨ç¤ºç‚º `HeapNumber`ã€‚V8 å°ˆé–€å° `Smi` é€²è¡Œå„ªåŒ–ï¼Œå› ç‚ºå°æ•´æ•¸åœ¨çœŸå¯¦ä¸–ç•Œçš„ JavaScript ç¨‹å¼ä¸­éå¸¸å¸¸è¦‹ã€‚`Smi` ä¸éœ€è¦åˆ†é…ç‚ºå…§å­˜ä¸­çš„å°ˆç”¨å¯¦é«”ï¼Œä¸”ç¸½é«”ä¸Šæ”¯æŒå¿«é€Ÿæ•´æ•¸æ“ä½œã€‚

é€™è£¡çš„é‡è¦å­¸åˆ°çš„æ˜¯ï¼Œ**å³ä½¿å…·æœ‰ç›¸åŒ JavaScript é¡å‹çš„å€¼ï¼Œåœ¨èƒŒå¾Œå¯èƒ½å®Œå…¨ä»¥ä¸åŒçš„æ–¹å¼è¡¨ç¤º**ï¼Œä½œç‚ºä¸€ç¨®å„ªåŒ–ã€‚

### `Smi` vs. `HeapNumber` vs. `MutableHeapNumber`

ä»¥ä¸‹æ˜¯å®ƒå¦‚ä½•åœ¨åº•å±¤é‹ä½œçš„ã€‚æˆ‘å€‘å‡è¨­æœ‰ä»¥ä¸‹å°è±¡ï¼š

```js
const o = {
  x: 42,  // Smi
  y: 4.2, // HeapNumber
};
```

å±¬æ€§ `x` çš„å€¼ `42` å¯ä»¥ç·¨ç¢¼ç‚º `Smi`ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å„²å­˜åœ¨å°è±¡å…§éƒ¨ã€‚è€Œå±¬æ€§ `y` çš„å€¼ `4.2` å‰‡éœ€è¦ä¸€å€‹å–®ç¨çš„å¯¦é«”ä¾†ä¿å­˜è©²å€¼ï¼Œä¸¦ä¸”è©²å°è±¡æŒ‡å‘è©²å¯¦é«”ã€‚

![](/_img/react-cliff/04-smi-vs-heapnumber.svg)

ç„¶å¾Œå‡è¨­é‹è¡Œä»¥ä¸‹ JavaScript ç¨‹å¼ç¢¼ç‰‡æ®µï¼š

```js
o.x += 10;
// â†’ o.x ç¾åœ¨æ˜¯ 52
o.y += 1;
// â†’ o.y ç¾åœ¨æ˜¯ 5.2
```

åœ¨æ­¤æƒ…æ³ä¸‹ï¼Œ`x` çš„å€¼å¯ä»¥ç›´æ¥åœ¨å…§éƒ¨æ›´æ–°ï¼Œå› ç‚ºæ–°å€¼ `52` åŒæ¨£ç¬¦åˆ `Smi` ç¯„åœã€‚

![](/_img/react-cliff/05-update-smi.svg)

ç„¶è€Œï¼Œæ–°çš„å€¼ `y=5.2` ç„¡æ³•é©é…æ–¼ `Smi`ï¼Œä¸¦ä¸”ä¹Ÿèˆ‡ä¹‹å‰çš„å€¼ `4.2` ä¸åŒï¼Œå› æ­¤ V8 éœ€è¦ç‚º `y` çš„è³¦å€¼åˆ†é…ä¸€å€‹æ–°çš„ `HeapNumber` å¯¦é«”ã€‚

![](/_img/react-cliff/06-update-heapnumber.svg)

`HeapNumber` æ˜¯ä¸å¯è®Šçš„ï¼Œé€™ä½¿å¾—æŸäº›å„ªåŒ–æˆç‚ºå¯èƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘å€‘å°‡ `y` çš„å€¼è³¦çµ¦ `x`ï¼š

```js
o.x = o.y;
// â†’ o.x ç¾åœ¨æ˜¯ 5.2
```

â€¦â€¦æˆ‘å€‘ç¾åœ¨åªéœ€éˆæ¥åˆ°ç›¸åŒçš„ `HeapNumber` è€Œä¸æ˜¯ç‚ºç›¸åŒçš„å€¼åˆ†é…ä¸€å€‹æ–°çš„ã€‚

![](/_img/react-cliff/07-heapnumbers.svg)

`HeapNumber` æ˜¯ä¸å¯è®Šçš„ï¼Œé€™æœ‰ä¸€å€‹ç¼ºé»ï¼Œå³å¦‚æœå€¼è¶…å‡º `Smi` ç¯„åœç¶“å¸¸è¢«æ›´æ–°æ™‚ï¼Œé€Ÿåº¦æœƒå¾ˆæ…¢ï¼Œä¾‹å¦‚ä»¥ä¸‹æƒ…æ³ï¼š

```js
// å‰µå»ºä¸€å€‹ `HeapNumber` å¯¦ä¾‹ã€‚
const o = { x: 0.1 };

for (let i = 0; i < 5; ++i) {
  // å‰µå»ºä¸€å€‹é¡å¤–çš„ `HeapNumber` å¯¦ä¾‹ã€‚
  o.x += 1;
}
```

ç¬¬ä¸€è¡Œå°‡å‰µå»ºä¸€å€‹åˆå§‹å€¼ç‚º `0.1` çš„ `HeapNumber` å¯¦ä¾‹ã€‚å¾ªç’°é«”å°‡è©²å€¼æ›´æ”¹ç‚º `1.1`ã€`2.1`ã€`3.1`ã€`4.1`ï¼Œæœ€çµ‚ç‚º `5.1`ï¼Œåœ¨æ­¤éç¨‹ä¸­ä¸€å…±å‰µå»ºäº†å…­å€‹ `HeapNumber` å¯¦ä¾‹ï¼Œå…¶ä¸­äº”å€‹åœ¨å¾ªç’°çµæŸå¾Œæˆç‚ºåƒåœ¾ã€‚

![](/_img/react-cliff/08-garbage-heapnumbers.svg)

ç‚ºé¿å…æ­¤å•é¡Œï¼ŒV8 æä¾›äº†ä¸€ç¨®æ–¹å¼ï¼Œä»¥ä½œç‚ºå„ªåŒ–ä¾†åŸåœ°æ›´æ–°é `Smi` æ•¸å­—å­—æ®µã€‚ç•¶æ•¸å€¼å­—æ®µçš„å€¼è¶…å‡º `Smi` ç¯„åœæ™‚ï¼ŒV8 æœƒåœ¨çµæ§‹ä¸­å°‡è©²å­—æ®µæ¨™è¨˜ç‚º `Double` å­—æ®µï¼Œä¸¦åˆ†é…ä¸€å€‹ç¨±ç‚º `MutableHeapNumber` çš„å°è±¡ï¼Œç”¨æ–¼å­˜æ”¾ä»¥ Float64 ç·¨ç¢¼çš„å¯¦éš›å€¼ã€‚

![](/_img/react-cliff/09-mutableheapnumber.svg)

ç•¶å­—æ®µçš„å€¼ç™¼ç”Ÿæ›´æ”¹æ™‚ï¼ŒV8 ä¸å†éœ€è¦åˆ†é…æ–°çš„ `HeapNumber`ï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥æ›´æ–°åŸåœ°çš„ `MutableHeapNumber`ã€‚

![](/_img/react-cliff/10-update-mutableheapnumber.svg)

ä¸éï¼Œé€™ç¨®æ–¹æ³•ä¹Ÿæœ‰ä¸€å€‹å•é¡Œã€‚ç”±æ–¼ `MutableHeapNumber` çš„å€¼å¯ä»¥æ›´æ”¹ï¼Œå› æ­¤é€™äº›å°è±¡ä¸èƒ½éš¨æ„å‚³éã€‚

![](/_img/react-cliff/11-mutableheapnumber-to-heapnumber.svg)

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°‡ `o.x` è³¦å€¼çµ¦è®Šé‡ `y`ï¼Œé‚£éº¼æ‚¨ä¸å¸Œæœ›ä¸‹æ¬¡ `o.x` æ›´æ”¹æ™‚ï¼Œ`y` çš„å€¼ä¹Ÿæ”¹è®Šâ€”â€”é€™æœƒé•å JavaScript è¦ç¯„ï¼å› æ­¤ï¼Œåœ¨è¨ªå• `o.x` æ™‚ï¼Œæ•¸å­—å¿…é ˆåœ¨è³¦å€¼çµ¦ `y` å‰é‡æ–° *å°è£* ç‚ºå¸¸è¦çš„ `HeapNumber`ã€‚

å°æ–¼æµ®é»æ•¸ï¼ŒV8 åœ¨å¹•å¾Œå®Œæˆä¸Šè¿°æ‰€æœ‰çš„â€œå°è£â€æ“ä½œã€‚ä½†æ˜¯å°æ–¼å°æ•´æ•¸ä¾†èªªï¼Œæ¡ç”¨ `MutableHeapNumber` æ–¹æ³•æœƒå¾ˆæµªè²»ï¼Œå› ç‚º `Smi` æ˜¯æ›´é«˜æ•ˆçš„è¡¨ç¤ºæ–¹å¼ã€‚

```js
const object = { x: 1 };
// â†’ å°æ–¼å°è±¡ä¸­çš„ `x` ç„¡éœ€â€œå°è£â€

object.x += 1;
// â†’ æ›´æ–°å°è±¡ä¸­ `x` çš„å€¼
```

ç‚ºäº†é¿å…ä½æ•ˆï¼Œæˆ‘å€‘åªéœ€å°‡çµæ§‹ä¸­çš„å­—æ®µæ¨™è¨˜ç‚º `Smi` è¡¨ç¤ºï¼Œä¸¦ä¸”åªè¦æ•¸å€¼é©é…å°æ•´æ•¸ç¯„åœï¼Œå°±ç›´æ¥åŸåœ°æ›´æ–°è©²æ•¸å€¼ã€‚

![](/_img/react-cliff/12-smi-no-boxing.svg)

## çµæ§‹çš„å»¢æ£„èˆ‡é·ç§»

é‚£éº¼å¦‚æœå­—æ®µæœ€åˆå®¹ç´çš„æ˜¯ `Smi`ï¼Œä½†ç¨å¾ŒåŒ…å«äº†è¶…å‡ºå°æ•´æ•¸ç¯„åœçš„æ•¸å€¼å‘¢ï¼Ÿä¾‹å¦‚ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œå…©å€‹å°è±¡æœ€åˆä½¿ç”¨ç›¸åŒçš„çµæ§‹ï¼Œå…¶ä¸­ `x` æœ€åˆè¢«è¡¨ç¤ºç‚º `Smi`ï¼š

```js
const a = { x: 1 };
const b = { x: 2 };
// â†’ å°è±¡çš„ `x` ç¾åœ¨æ˜¯ `Smi` å­—æ®µ

b.x = 0.2;
// â†’ `b.x` ç¾åœ¨è¢«è¡¨ç¤ºç‚º `Double`

y = a.x;
```

é€™å¾å…©å€‹æŒ‡å‘ç›¸åŒçµæ§‹çš„å°è±¡é–‹å§‹ï¼Œå…¶ä¸­ `x` è¢«æ¨™è¨˜ç‚º `Smi` è¡¨ç¤ºï¼š

![](/_img/react-cliff/13-shape.svg)

ç•¶ `b.x` æ›´æ”¹ç‚º `Double` è¡¨ç¤ºæ™‚ï¼ŒV8 åˆ†é…ä¸€å€‹æ–°çš„çµæ§‹ï¼Œå…¶ä¸­ `x` è¢«åˆ†é…ç‚º `Double` è¡¨ç¤ºï¼Œä¸¦ä¸”è©²çµæ§‹æŒ‡å‘åˆå§‹çš„ç©ºçµæ§‹ã€‚V8 åŒæ™‚åˆ†é…ä¸€å€‹ `MutableHeapNumber` ç”¨æ–¼å­˜æ”¾ `x` å±¬æ€§çš„å€¼ `0.2`ã€‚ç„¶å¾Œæˆ‘å€‘æ›´æ–°å°è±¡ `b` æŒ‡å‘è©²æ–°çµæ§‹ï¼Œä¸¦å°‡å°è±¡ä¸­çš„æ§½ä½æ›´æ–°ç‚ºæŒ‡å‘å‰›åˆ†é…çš„ `MutableHeapNumber` åç§» 0 çš„ä½ç½®ã€‚æœ€å¾Œï¼Œæˆ‘å€‘æ¨™è¨˜èˆŠçµæ§‹ç‚ºå»¢æ£„ä¸¦å°‡å…¶å¾é·ç§»æ¨¹ä¸­è§£é™¤éˆæ¥ã€‚é€™æ˜¯é€šéå°ç©ºçµæ§‹ä¸­çš„ `&apos;x&apos;` æ·»åŠ åˆ°æ–°å‰µå»ºçš„çµæ§‹çš„è½‰æ›ä¾†å®Œæˆçš„ã€‚

![](/_img/react-cliff/14-shape-transition.svg)

æ­¤æ™‚æˆ‘å€‘ç„¡æ³•å®Œå…¨ç§»é™¤èˆŠçµæ§‹ï¼Œå› ç‚ºå®ƒä»ç„¶è¢« `a` ä½¿ç”¨ï¼Œä¸¦ä¸”ä¸»å‹•éæ­·å…§å­˜ä»¥æŸ¥æ‰¾æ‰€æœ‰æŒ‡å‘èˆŠçµæ§‹çš„å°è±¡ä¸¦æ›´æ–°å®ƒå€‘æˆæœ¬å¤ªé«˜ã€‚ç›¸åï¼ŒV8 æ¡ç”¨å»¶é²è™•ç†çš„æ–¹å¼ï¼šå° `a` çš„ä»»ä½•å±¬æ€§è¨ªå•æˆ–åˆ†é…æ“ä½œéƒ½æœƒé¦–å…ˆå°‡å…¶é·ç§»åˆ°æ–°çµæ§‹ã€‚ç†è«–ä¸Šï¼Œæœ€çµ‚èˆŠçµæ§‹å°‡è®Šå¾—ä¸å¯é”ï¼Œä¸¦ç”±åƒåœ¾æ”¶é›†å™¨ç§»é™¤ã€‚

![](/_img/react-cliff/15-shape-deprecation.svg)

ç•¶æ›´æ”¹è¡¨ç¤ºçš„å­—æ®µä¸æ˜¯éˆä¸­çš„æœ€å¾Œä¸€å€‹æ™‚ï¼Œæƒ…æ³æœƒæ›´åŠ æ£˜æ‰‹ï¼š

```js
const o = {
  x: 1,
  y: 2,
  z: 3,
};

o.y = 0.1;
```

åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼ŒV8 éœ€è¦æ‰¾åˆ°æ‰€è¬‚çš„ _æ‹†åˆ†çµæ§‹_ï¼Œå³éˆä¸­æœ€å¾Œä¸€å€‹æœªå¼•å…¥ç›¸é—œå±¬æ€§çš„çµæ§‹ã€‚åœ¨æˆ‘å€‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘å€‘æ”¹è®Šçš„æ˜¯ `y`ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦æ‰¾åˆ°æœ€å¾Œä¸€å€‹æ²’æœ‰ `y` çš„çµæ§‹ï¼Œé€™å°±æ˜¯å¼•å…¥äº† `x` çš„çµæ§‹ã€‚

![](/_img/react-cliff/16-split-shape.svg)

å¾åˆ†è£‚å½¢ç‹€é–‹å§‹ï¼Œæˆ‘å€‘ç‚º `y` å‰µå»ºäº†ä¸€å€‹æ–°çš„éæ¸¡éˆï¼Œé‡æ’­æ‰€æœ‰ä¹‹å‰çš„éæ¸¡ï¼Œä½†å°‡ `&apos;y&apos;` æ¨™è¨˜ç‚º `Double` è¡¨ç¤ºã€‚æˆ‘å€‘ä½¿ç”¨é€™å€‹æ–°çš„éæ¸¡éˆä½œç‚º `y` çš„éæ¸¡ï¼Œä¸¦å°‡èˆŠå­æ¨¹æ¨™è¨˜ç‚ºå·²æ£„ç”¨ã€‚åœ¨æœ€å¾Œä¸€æ­¥ä¸­ï¼Œæˆ‘å€‘å°‡å¯¦ä¾‹ `o` é·ç§»åˆ°æ–°å½¢ç‹€ï¼Œç¾åœ¨ä½¿ç”¨ `MutableHeapNumber` å­˜å„² `y` çš„å€¼ã€‚é€™æ¨£ï¼Œæ–°çš„å°è±¡å°±ä¸æœƒå†èµ°èˆŠçš„è·¯å¾‘ï¼Œä¸¦ä¸”ä¸€æ—¦æ‰€æœ‰æŒ‡å‘èˆŠå½¢ç‹€çš„å¼•ç”¨éƒ½æ¶ˆå¤±ï¼Œæ¨¹ä¸­å·²æ£„ç”¨çš„å½¢ç‹€éƒ¨åˆ†å°±æœƒæ¶ˆå¤±ã€‚

## å¯æ“´å±•æ€§èˆ‡å®Œæ•´æ€§ç´šåˆ¥çš„éæ¸¡

`Object.preventExtensions()` é˜»æ­¢å°è±¡æ·»åŠ æ–°å±¬æ€§ã€‚å¦‚æœå˜—è©¦æ·»åŠ ï¼Œå®ƒæœƒæ‹‹å‡ºä¸€å€‹ç•°å¸¸ã€‚ï¼ˆå¦‚æœä¸æ˜¯åœ¨åš´æ ¼æ¨¡å¼ä¸‹ï¼Œå®ƒä¸æœƒæ‹‹å‡ºç•°å¸¸ï¼Œè€Œæ˜¯é»˜é»˜åœ°ä»€éº¼ä¹Ÿä¸åšã€‚ï¼‰

```js
const object = { x: 1 };
Object.preventExtensions(object);
object.y = 2;
// TypeError: ç„¡æ³•æ·»åŠ å±¬æ€§ y;
//            object ä¸å¯æ“´å±•
```

`Object.seal` çš„ä½œç”¨èˆ‡ `Object.preventExtensions` ç›¸åŒï¼Œä½†å®ƒé‚„å°‡æ‰€æœ‰å±¬æ€§æ¨™è¨˜ç‚ºä¸å¯é…ç½®ï¼Œé€™æ„å‘³è‘—ä½ ç„¡æ³•åˆªé™¤å®ƒå€‘ï¼Œä¹Ÿä¸èƒ½æ›´æ”¹å®ƒå€‘çš„å¯æšèˆ‰æ€§ã€å¯é…ç½®æ€§æˆ–å¯å¯«æ€§ã€‚

```js
const object = { x: 1 };
Object.seal(object);
object.y = 2;
// TypeError: ç„¡æ³•æ·»åŠ å±¬æ€§ y;
//            object ä¸å¯æ“´å±•
delete object.x;
// TypeError: ç„¡æ³•åˆªé™¤å±¬æ€§ x
```

`Object.freeze` çš„ä½œç”¨èˆ‡ `Object.seal` ç›¸åŒï¼Œä½†å®ƒé‚„é˜²æ­¢ç¾æœ‰å±¬æ€§çš„å€¼è¢«æ›´æ”¹ï¼Œé€šéå°‡å®ƒå€‘æ¨™è¨˜ç‚ºä¸å¯å¯«ã€‚

```js
const object = { x: 1 };
Object.freeze(object);
object.y = 2;
// TypeError: ç„¡æ³•æ·»åŠ å±¬æ€§ y;
//            object ä¸å¯æ“´å±•
delete object.x;
// TypeError: ç„¡æ³•åˆªé™¤å±¬æ€§ x
object.x = 3;
// TypeError: ç„¡æ³•è³¦å€¼çµ¦åªè®€å±¬æ€§ x
```

è®“æˆ‘å€‘çœ‹çœ‹é€™å€‹å…·é«”çš„ç¤ºä¾‹ï¼Œæœ‰å…©å€‹å°è±¡éƒ½åªæœ‰ä¸€å€‹å±¬æ€§ `x`ï¼Œç„¶å¾Œæˆ‘å€‘é˜»æ­¢ç¬¬äºŒå€‹å°è±¡é€²ä¸€æ­¥æ“´å±•ã€‚

```js
const a = { x: 1 };
const b = { x: 2 };

Object.preventExtensions(b);
```

ä¸€é–‹å§‹å°±åƒæˆ‘å€‘å·²çŸ¥çš„ä¸€æ¨£ï¼Œå¾ç©ºå½¢ç‹€éæ¸¡åˆ°åŒ…å«å±¬æ€§ `&apos;x&apos;` çš„æ–°å½¢ç‹€(è¡¨ç¤ºç‚º `Smi`)ã€‚ç•¶æˆ‘å€‘é˜»æ­¢å° `b` çš„æ“´å±•æ™‚ï¼Œæˆ‘å€‘åŸ·è¡Œäº†ä¸€å€‹ç‰¹åˆ¥éæ¸¡åˆ°æ¨™è¨˜ç‚ºä¸å¯æ“´å±•çš„æ–°å½¢ç‹€ã€‚é€™ç¨®ç‰¹æ®Šéæ¸¡ä¸¦æœªå¼•å…¥ä»»ä½•æ–°å±¬æ€§â€”â€”å®ƒçœŸçš„åªæ˜¯å€‹æ¨™è¨˜ã€‚

![](/_img/react-cliff/17-shape-nonextensible.svg)

æ³¨æ„ï¼Œæˆ‘å€‘ä¸èƒ½å°±åœ°æ›´æ–°åŒ…å« `x` çš„å½¢ç‹€ï¼Œå› ç‚ºå¦ä¸€å€‹å°è±¡ `a` ä»ç„¶æ˜¯å¯æ“´å±•çš„ï¼Œè€Œä¸”éœ€è¦è©²å½¢ç‹€ã€‚

## React æ€§èƒ½å•é¡Œ

è®“æˆ‘å€‘å°‡æ‰€æœ‰å­¸åˆ°çš„çµåˆèµ·ä¾†ï¼Œäº†è§£[æœ€è¿‘çš„ React å•é¡Œ #14365](https://github.com/facebook/react/issues/14365)ã€‚ç•¶ React åœ˜éšŠå°ä¸€å€‹çœŸå¯¦çš„æ‡‰ç”¨ç¨‹åºé€²è¡Œå‰–ææ™‚ï¼Œä»–å€‘ç™¼ç¾äº†ä¸€å€‹å¥‡æ€ªçš„ V8 æ€§èƒ½ç“¶é ¸ï¼Œå½±éŸ¿åˆ°äº† React çš„æ ¸å¿ƒã€‚ä»¥ä¸‹æ˜¯è©²å•é¡Œçš„ç°¡åŒ–é‡ç¾ç¤ºä¾‹ï¼š

```js
const o = { x: 1, y: 2 };
Object.preventExtensions(o);
o.y = 0.2;
```

æˆ‘å€‘æœ‰ä¸€å€‹å°è±¡ï¼ŒåŒ…å«å…©å€‹å­—æ®µï¼Œé€™äº›å­—æ®µå…·æœ‰ `Smi` è¡¨ç¤ºã€‚æˆ‘å€‘é˜»æ­¢è©²å°è±¡çš„é€²ä¸€æ­¥æ“´å±•ï¼Œæœ€çµ‚å°‡ç¬¬äºŒå€‹å­—æ®µå¼·åˆ¶ç‚º `Double` è¡¨ç¤ºã€‚

æ­£å¦‚æˆ‘å€‘ä¹‹å‰æ‰€å­¸ï¼Œé€™å¤§è‡´å‰µå»ºäº†ä»¥ä¸‹è¨­ç½®ï¼š

![](/_img/react-cliff/18-repro-shape-setup.svg)

å…©å€‹å±¬æ€§éƒ½æ¨™è¨˜ç‚º `Smi` è¡¨ç¤ºï¼Œæœ€å¾Œçš„éæ¸¡æ˜¯å¯æ“´å±•æ€§çš„éæ¸¡ï¼Œä»¥å°‡å½¢ç‹€æ¨™è¨˜ç‚ºä¸å¯æ“´å±•ã€‚

ç¾åœ¨æˆ‘å€‘éœ€è¦å°‡ `y` æ›´æ”¹ç‚º `Double` è¡¨ç¤ºï¼Œé€™æ„å‘³è‘—æˆ‘å€‘éœ€è¦å†æ¬¡å¾åˆ†è£‚å½¢ç‹€é–‹å§‹ã€‚åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œå¼•å…¥ `x` çš„æ˜¯åˆ†è£‚å½¢ç‹€ã€‚ä½†ç¾åœ¨ V8 é‡åˆ°äº†å›°æƒ‘ï¼Œå› ç‚ºåˆ†è£‚å½¢ç‹€æ˜¯å¯æ“´å±•çš„ï¼Œè€Œç•¶å‰å½¢ç‹€è¢«æ¨™è¨˜ç‚ºä¸å¯æ“´å±•ã€‚V8 ç¢ºå¯¦ä¸çŸ¥é“å¦‚ä½•æ­£ç¢ºé‡æ’­é€™äº›éæ¸¡ã€‚å› æ­¤ï¼ŒV8 åŸºæœ¬ä¸Šåªæ˜¯æ”¾æ£„äº†ç†è§£ï¼Œä¸¦å‰µå»ºäº†ä¸€å€‹èˆ‡ç¾æœ‰å½¢ç‹€æ¨¹ç„¡é—œä¸”æœªèˆ‡ä»»ä½•å…¶ä»–å°è±¡å…±äº«çš„å–®ç¨å½¢ç‹€ã€‚å¯ä»¥å°‡å…¶è¦–ç‚ºä¸€å€‹å­¤ç«‹å½¢ç‹€ï¼š

![](/_img/react-cliff/19-orphaned-shape.svg)

ä½ å¯ä»¥æƒ³åƒï¼Œå¦‚æœé€™ç¨®æƒ…æ³ç™¼ç”Ÿåœ¨å¾ˆå¤šå°è±¡ä¸Šï¼Œé‚£éº¼æ•´å€‹å½¢ç‹€ç³»çµ±å°±æœƒè®Šå¾—æ¯«ç„¡ç”¨è™•ã€‚

åœ¨ React çš„æƒ…æ³ä¸‹ï¼Œç™¼ç”Ÿäº†ä»¥ä¸‹æƒ…æ³ï¼šæ¯å€‹ `FiberNode` éƒ½æœ‰å¹¾å€‹å­—æ®µï¼Œç•¶é–‹å•Ÿå‰–æåŠŸèƒ½æ™‚ï¼Œé€™äº›å­—æ®µæ‡‰è©²å­˜å„²æ™‚é–“æˆ³ã€‚

```js
class FiberNode {
  constructor() {
    this.actualStartTime = 0;
    Object.preventExtensions(this);
  }
}

const node1 = new FiberNode();
const node2 = new FiberNode();
```

é€™äº›å­—æ®µï¼ˆå¦‚ `actualStartTime`ï¼‰åˆå§‹åŒ–ç‚º `0` æˆ– `-1`ï¼Œå› æ­¤é–‹å§‹æ™‚å…·æœ‰ `Smi` è¡¨ç¤ºã€‚ä½†å¾Œä¾†ï¼Œä¾†è‡ª [`performance.now()`](https://w3c.github.io/hr-time/#dom-performance-now) çš„å¯¦éš›æµ®é»æ™‚é–“æˆ³å­˜å„²åœ¨é€™äº›å­—æ®µä¸­ï¼Œå› ç‚ºå®ƒå€‘ç„¡æ³•é©æ‡‰ `Smi`ï¼Œé€™ä½¿å¾—å®ƒå€‘è®Šç‚º `Double` è¡¨ç¤ºã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒReact é‚„é˜»æ­¢å° `FiberNode` å¯¦ä¾‹çš„æ“´å±•ã€‚

æœ€åˆï¼Œä¸Šè¿°ç°¡åŒ–çš„ç¤ºä¾‹çœ‹èµ·ä¾†åƒé€™æ¨£ï¼š

![](/_img/react-cliff/20-fibernode-shape.svg)

æœ‰å…©å€‹å¯¦ä¾‹å…±äº«ä¸€å€‹å½¢ç‹€æ¨¹ï¼Œä¸€åˆ‡éƒ½æŒ‰é æœŸå·¥ä½œã€‚ä½†éš¨å¾Œï¼Œç•¶ä½ å­˜å„²çœŸå¯¦çš„æ™‚é–“æˆ³æ™‚ï¼ŒV8 åœ¨æ‰¾åˆ°åˆ†è£‚å½¢ç‹€æ™‚é‡åˆ°äº†å›°æƒ‘ï¼š

![](/_img/react-cliff/21-orphan-islands.svg)

V8 ç‚º `node1` åˆ†é…äº†ä¸€å€‹æ–°çš„å­¤ç«‹å½¢ç‹€ï¼Œç¨å¾Œ `node2` ç™¼ç”Ÿç›¸åŒæƒ…æ³ï¼Œå°è‡´å‡ºç¾å…©å€‹ _å­¤ç«‹å³¶å¶¼_ï¼Œæ¯å€‹éƒ½æœ‰è‡ªå·±ç¨ç«‹çš„å½¢ç‹€ã€‚è¨±å¤šå¯¦éš›æ‡‰ç”¨ä¸­çš„ React æ‡‰ç”¨ä¸åƒ…åªæœ‰å…©å€‹ï¼Œè€Œæ˜¯æœ‰æ•¸è¬å€‹é€™æ¨£çš„ `FiberNode`ã€‚å¦‚æ‚¨æ‰€æƒ³ï¼Œé€™ç¨®æƒ…æ³å°æ–¼ V8 çš„æ€§èƒ½è¡¨ç¾ä¸¦ä¸æ˜¯ç‰¹åˆ¥å‹å¥½ã€‚

å¹¸é‹çš„æ˜¯ï¼Œ[æˆ‘å€‘å·²è§£æ±ºäº†é€™å€‹æ€§èƒ½ç“¶é ¸](https://chromium-review.googlesource.com/c/v8/v8/+/1442640/) åœ¨ [V8 v7.4](/blog/v8-release-74)ï¼Œæˆ‘å€‘æ­£ [åŠªåŠ›é™ä½å­—æ®µè¡¨ç¤ºæ›´æ”¹çš„æˆæœ¬](https://bit.ly/v8-in-place-field-representation-changes)ï¼Œä»¥æ¶ˆé™¤å‰©é¤˜çš„æ€§èƒ½ç“¶é ¸ã€‚ä¿®å¾©ä¹‹å¾Œï¼ŒV8 ç¾åœ¨åšäº†æ­£ç¢ºçš„äº‹æƒ…ï¼š

![](/_img/react-cliff/22-fix.svg)

å…©å€‹ `FiberNode` å¯¦ä¾‹æŒ‡å‘ä¸€å€‹ä¸å¯æ“´å±•çš„å½¢ç‹€ï¼Œå…¶ä¸­ `&apos;actualStartTime&apos;` æ˜¯ä¸€å€‹ `Smi` å­—æ®µã€‚ç•¶é¦–æ¬¡å° `node1.actualStartTime` è³¦å€¼æ™‚ï¼Œå‰µå»ºäº†ä¸€æ¢æ–°çš„éæ¸¡éˆï¼Œä¸¦ä¸”å…ˆå‰çš„éˆè¢«æ¨™è¨˜ç‚ºå·²æ£„ç”¨ï¼š

![](/_img/react-cliff/23-fix-fibernode-shape-1.svg)

æ³¨æ„ï¼Œç¾åœ¨å»¶å±•æ€§éæ¸¡æ­£ç¢ºåœ°è¢«é‡æ”¾åˆ°æ–°éˆä¸­ã€‚

![](/_img/react-cliff/24-fix-fibernode-shape-2.svg)

åœ¨å° `node2.actualStartTime` è³¦å€¼å¾Œï¼Œå…©å€‹ç¯€é»éƒ½æŒ‡å‘æ–°çš„å½¢ç‹€ï¼Œè€Œåƒåœ¾å›æ”¶å™¨å¯ä»¥æ¸…ç†éæ¸¡æ¨¹ä¸­çš„æ£„ç”¨éƒ¨åˆ†ã€‚

:::note
**æ³¨æ„:** æ‚¨å¯èƒ½æœƒèªç‚ºæ‰€æœ‰é€™äº›å½¢ç‹€æ£„ç”¨å’Œé·ç§»å¾ˆè¤‡é›œï¼Œç¢ºå¯¦å¦‚æ­¤ã€‚äº‹å¯¦ä¸Šï¼Œæˆ‘å€‘çŒœæ¸¬åœ¨å¯¦éš›ç¶²ç«™ä¸Šå®ƒå¸¶ä¾†çš„å•é¡Œï¼ˆæ€§èƒ½ã€è¨˜æ†¶é«”ä½¿ç”¨å’Œè¤‡é›œæ€§ï¼‰æ¯”å®ƒè§£æ±ºçš„å•é¡Œæ›´å¤šï¼Œç‰¹åˆ¥æ˜¯éš¨è‘— [æŒ‡é‡å£“ç¸®](https://bugs.chromium.org/p/v8/issues/detail?id=7703) çš„å‡ºç¾ï¼Œæˆ‘å€‘ç„¡æ³•å†ä½¿ç”¨å®ƒåœ¨ç‰©ä»¶å…§è¯å­˜å„²é›™ç²¾åº¦å€¼ã€‚å› æ­¤ï¼Œæˆ‘å€‘å¸Œæœ› [å®Œå…¨ç§»é™¤ V8 çš„å½¢ç‹€æ£„ç”¨æ©Ÿåˆ¶](https://bugs.chromium.org/p/v8/issues/detail?id=9606)ã€‚æ‚¨å¯ä»¥èªªå®ƒæ˜¯ _\*æˆ´ä¸Šå¤ªé™½é¡\*_ è¢«æ£„ç”¨äº†ã€‚ _è€¶â€¦_
:::

React åœ˜éšŠ [åœ¨å…¶ç«¯ç·©è§£äº†é€™å€‹å•é¡Œ](https://github.com/facebook/react/pull/14383)ï¼Œç¢ºä¿æ‰€æœ‰ `FiberNode` çš„æ™‚é–“å’ŒæŒçºŒæ™‚é–“å­—æ®µå¾ä¸€é–‹å§‹å°±ä½¿ç”¨ `Double` è¡¨ç¤ºï¼š

```js
class FiberNode {
  constructor() {
    // å¾ä¸€é–‹å§‹å¼·åˆ¶ä½¿ç”¨ `Double` è¡¨ç¤ºã€‚
    this.actualStartTime = Number.NaN;
    // ç¨å¾Œï¼Œæ‚¨ä»ç„¶å¯ä»¥åˆå§‹åŒ–ç‚ºæ‚¨æƒ³è¦çš„å€¼ï¼š
    this.actualStartTime = 0;
    Object.preventExtensions(this);
  }
}

const node1 = new FiberNode();
const node2 = new FiberNode();
```

æ›¿ä»£ `Number.NaN`ï¼Œä»»ä½•ä¸ç¬¦åˆ `Smi` èŒƒåœçš„æµ®é»å€¼å‡å¯ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼š`0.000001`ã€`Number.MIN_VALUE`ã€`-0` å’Œ `Infinity`ã€‚

å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œå…·é«”çš„ React éŒ¯èª¤æ˜¯ V8 ç‰¹æœ‰çš„ï¼Œç¸½é«”è€Œè¨€ï¼Œé–‹ç™¼è€…ä¸æ‡‰è©²é‡å°ç‰¹å®šç‰ˆæœ¬çš„ JavaScript å¼•æ“é€²è¡Œå„ªåŒ–ã€‚ä¸éï¼Œåœ¨äº‹æƒ…å‡ºå•é¡Œæ™‚æ“æœ‰å¯ä»¥è™•ç†çš„æ–¹å¼é‚„æ˜¯å¾ˆå¥½çš„ã€‚

è«‹è¨˜ä½ï¼ŒJavaScript å¼•æ“åœ¨åº•å±¤é€²è¡Œäº†ä¸€äº›é­”æ³•æ“ä½œï¼Œæ‚¨å¯ä»¥é€šéç›¡é‡é¿å…æ··åˆé¡å‹ä¾†å¹«åŠ©å®ƒã€‚ä¾‹å¦‚ï¼Œè«‹ä¸è¦ä½¿ç”¨ `null` åˆå§‹åŒ–æ‚¨çš„æ•¸å€¼å­—æ®µï¼Œå› ç‚ºé€™æœƒç¦ç”¨å­—æ®µè¡¨ç¤ºè¿½è¹¤çš„æ‰€æœ‰å¥½è™•ï¼Œè€Œä¸”ä»¤æ‚¨çš„ä»£ç¢¼æ›´å…·å¯è®€æ€§ï¼š

```js
// ä¸è¦é€™æ¨£åš!
class Point {
  x = null;
  y = null;
}

const p = new Point();
p.x = 0.1;
p.y = 402;
```

æ›å¥è©±èªªï¼Œ**ç·¨å¯«å¯è®€çš„ä»£ç¢¼ï¼Œæ€§èƒ½å°±æœƒè·Ÿéš¨ï¼**

## ç¸½çµ

æˆ‘å€‘åœ¨æœ¬æ¬¡æ·±å…¥æ¢è¨ä¸­ä»‹ç´¹äº†ä»¥ä¸‹å…§å®¹ï¼š

- JavaScript å€åˆ†â€œåŸå§‹å€¼â€å’Œâ€œç‰©ä»¶â€ï¼Œè€Œ `typeof` æ˜¯èªªè¬Šçš„ã€‚
- å³ä½¿å…·æœ‰ç›¸åŒ JavaScript é¡å‹çš„å€¼ï¼Œåœ¨å¾Œç«¯ä¹Ÿå¯èƒ½æœ‰ä¸åŒçš„è¡¨ç¤ºå½¢å¼ã€‚
- V8 è©¦åœ–ç‚ºæ‚¨çš„ JavaScript ç¨‹åºä¸­çš„æ¯å€‹å±¬æ€§æ‰¾åˆ°æœ€ä½³è¡¨ç¤ºæ–¹å¼ã€‚
- æˆ‘å€‘è¨è«–äº† V8 å¦‚ä½•è™•ç†å½¢ç‹€æ£„ç”¨å’Œé·ç§»ï¼ŒåŒ…æ‹¬å»¶å±•æ€§éæ¸¡ã€‚

åŸºæ–¼é€™äº›çŸ¥è­˜ï¼Œæˆ‘å€‘ç¢ºå®šäº†ä¸€äº›å¯¦ç”¨çš„ JavaScript ç·¨ç¢¼æŠ€å·§ï¼Œæœ‰åŠ©æ–¼æé«˜æ€§èƒ½ï¼š

- å§‹çµ‚ä»¥ä¸€è‡´çš„æ–¹å¼åˆå§‹åŒ–æ‚¨çš„ç‰©ä»¶ï¼Œä»¥ä½¿å½¢ç‹€èƒ½å¤ æœ‰æ•ˆé‹ä½œã€‚
- ç‚ºæ‚¨çš„å­—æ®µé¸æ“‡åˆç†çš„åˆå§‹å€¼ï¼Œä»¥å¹«åŠ© JavaScript å¼•æ“é€²è¡Œè¡¨ç¤ºé¸æ“‡ã€‚
